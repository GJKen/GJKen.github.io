!function(h,n){"use strict";h.FilteringLog=function(t,e,i){var o=n.EventNotifier,f=n.UrlUtils,l=n.LogEvents;this.tabsInfo=new t,this.framesMap=e,this.UI=i,this.lastTabId=1,this.openedFilteringLogsPage=0,this.REQUESTS_SIZE_PER_TAB=1e3,this.synchronizeOpenTabs=function(l){var t=function(t){for(var e=this.tabsInfo.collection().slice(0),i=0;i<t.length;i++){var n=t[i],s=this.tabsInfo.get(n);s?this.updateTab(n):this.addTab(n);var a=e.indexOf(s);0<=a&&e.splice(a,1)}for(var r=0;r<e.length;r++)this.removeTab(e[r].tab);if("function"==typeof l){var o=[];for(var f in this.tabsInfo.tabsById)o.push(this.tabsInfo.tabsById[f].value);l(o)}}.bind(this);h.UI.getAllOpenedTabs(t)},this.clearEventsForTab=function(t){var e=this.tabsInfo.get(t);e&&(delete e.filteringEvents,o.notifyListeners(n.LogEvents.TAB_RESET,this.serializeTabInfo(e)))},this.addTab=function(t){var e=this._updateTabInfo(t);e&&o.notifyListeners(n.LogEvents.TAB_ADDED,this.serializeTabInfo(e))},this.removeTab=function(t){var e=this.tabsInfo.get(t);e&&o.notifyListeners(n.LogEvents.TAB_CLOSE,this.serializeTabInfo(e)),this.tabsInfo.remove(t)},this.updateTab=function(t){var e=this._updateTabInfo(t);e&&o.notifyListeners(n.LogEvents.TAB_UPDATE,this.serializeTabInfo(e))},this._updateTabInfo=function(t){var e=this.tabsInfo.get(t)||Object.create(null);return e.tabId||(e.tabId=this.lastTabId++),e.tab=t,e.isHttp=f.isHttpRequest(t.url),this.tabsInfo.set(t,e),e},this.reloadTabById=function(t){var e=this.getTabInfoById(t);e&&e.tab.reload(e.tab.url)},this.getTabInfoById=function(t){for(var e=this.tabsInfo.collection(),i=0;i<e.length;i++)if(e[i].tabId==t)return e[i];return null},this.getTabFrameInfoById=function(t){var e=this.getTabInfoById(t);return e?this.framesMap.getFrameInfo(e.tab):null},this.getTabInfo=function(t){var e=this.tabsInfo.get(t);return this.serializeTabInfo(e)},this.clearEventsForTab=function(t){var e=this.tabsInfo.get(t);e&&(delete e.filteringEvents,o.notifyListeners(l.TAB_RESET,this.serializeTabInfo(e)))},this.addEvent=function(t,e,i,n,s){if(0!=this.openedFilteringLogsPage){var a=this.tabsInfo.get(t);if(a){a.filteringEvents||(a.filteringEvents=[]);var r={requestUrl:e,requestDomain:f.getDomainName(e),frameUrl:i,frameDomain:f.getDomainName(i),requestType:n,requestThirdParty:f.isThirdPartyRequest(e,i),requestRule:s};s&&(r.requestRule=Object.create(null),r.requestRule.filterId=s.filterId,r.requestRule.ruleText=s.ruleText,r.requestRule.whiteListRule=s.whiteListRule),a.filteringEvents.push(r),a.filteringEvents.length>h.FilteringLog.REQUESTS_SIZE_PER_TAB&&a.filteringEvents.splice(1,1),o.notifyListeners(l.EVENT_ADDED,this.serializeTabInfo(a),r)}}},this.updateEvent=function(t,e,i){var n={requestUrl:e,loadTime:i};if(null!=t){var s=this.tabsInfo.get(t);s&&o.notifyListeners(l.EVENT_UPDATE,this.serializeTabInfo(s),n)}},this.clearEventsByTabId=function(t){var e=this.getTabInfoById(t);e&&(delete e.filteringEvents,o.notifyListeners(l.TAB_RESET,this.serializeTabInfo(e)))},this.onOpenFilteringLogPage=function(){this.openedFilteringLogsPage++},this.onCloseFilteringLogPage=function(){if(this.openedFilteringLogsPage=Math.max(this.openedFilteringLogsPage-1,0),0==this.openedFilteringLogsPage)for(var t=this.tabsInfo.collection(),e=0;e<t.length;e++)delete t[e].filteringEvents},this.serializeTabInfo=function(t){return t?{tabId:t.tabId,isHttp:t.isHttp,filteringEvents:t.filteringEvents,tab:{title:t.tab.title}}:null}}}(yiclearAPI,vAPI);