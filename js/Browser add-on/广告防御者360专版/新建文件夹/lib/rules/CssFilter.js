!function(a,m){"use strict";var i=a.BaseFilterRule,s=34<m.ext.app.getBrowserVersion(),t=m.platformUtils.isFirefoxBrowser(),n=m.platformUtils.isShadowDomSupported();a.CssFilter=function(e){if(this.commonCss=null,this.commonCssHits=null,this.commonRules=[],this.domainSensitiveRules=[],this.exceptionRules=[],this.extendedCssRules=[],this.dirty=!1,this.interceptPrefix="yi-intercept",this.ruleByKeyMap=Object.create(null),this.keyByRuleMap=Object.create(null),e)for(var s=0;s<e.length;s++)this.addRule(e[s])},a.CssFilter.prototype={addRule:function(e){e.whiteListRule?this.exceptionRules.push(e):e.extendedCss?this.extendedCssRules.push(e):e.isDomainSensitive()?this.domainSensitiveRules.push(e):this.commonRules.push(e),this._addRuleToMap(e),this.dirty=!0},removeRule:function(e){var s=e.ruleText;this.exceptionRules=this.exceptionRules.filter(function(e){return e.ruleText!=s}),this.extendedCssRules=this.extendedCssRules.filter(function(e){return e.ruleText!=s}),this.domainSensitiveRules=this.domainSensitiveRules.filter(function(e){return e.ruleText!=s}),this.commonRules=this.commonRules.filter(function(e){return e.ruleText!=s}),this._rollbackExceptionRule(e),this._deleteRuleFromMap(e),this.dirty=!0},clearRules:function(){this.commonRules=[],this.domainSensitiveRules=[],this.exceptionRules=[],this.extendedCssRules=[],this.commonCss=null,this.ruleByKeyMap=Object.create(null),this.keyByRuleMap=Object.create(null),this.dirty=!0},getRules:function(){return[].concat(this.commonRules).concat(this.domainSensitiveRules).concat(this.exceptionRules).concat(this.extendedCssRules)},buildCss:function(e,s){this._rebuild();var t=this._filterRules(e,s),i=this._createCssStylesheets(t);return s||(i.css=this._getCommonCss().concat(i.css)),i},buildInjectCss:function(e,s){this._rebuildBinding();var t,i=this._filterDomainSensitiveRules(e),n=[];if(null!==i&&(n=i.filter(function(e){return(e.isInjectRule||e.extendedCss)&&(!s||!e.isGeneric())})),s)t=n;else{var l=this.commonRules.filter(function(e){return e.isInjectRule});t=n.concat(l)}return this._createCssStylesheets(t)},buildCssHits:function(e,s,t){this._rebuildHits(s);var i=this._filterRules(e,t),n=this._createCssStylesheetsHits(i,s);return t||(n.css=this._getCommonCssHits(s).concat(n.css)),n},_filterRules:function(e,s){var t,i=this._filterDomainSensitiveRules(e);if(s){var n=[];null!==i&&(n=i.filter(function(e){return!e.isGeneric()})),t=n}else t=i;return t},_createCssStylesheets:function(e){var s=e.filter(function(e){return e.extendedCss}),t=e.filter(function(e){return!e.extendedCss});return{css:this._buildCssByRules(t),extendedCss:this._buildCssByRules(s)}},_createCssStylesheetsHits:function(e,s){var t=e.filter(function(e){return e.extendedCss}),i=e.filter(function(e){return!e.extendedCss});return{css:this._buildCssByRulesHits(i,a.Prefs.csspath+s),extendedCss:this._buildCssByRulesHits(t,a.Prefs.csspath+s)}},getRuleForKey:function(e){return e in this.ruleByKeyMap?this.ruleByKeyMap[e]:null},_deleteRuleFromMap:function(e){if(t){var s=this.keyByRuleMap[e.ruleText];delete this.ruleByKeyMap[s],delete this.keyByRuleMap[e.ruleText]}},_addRuleToMap:function(e){if(t){if(e.ruleText in this.keyByRuleMap)return;for(var s;(s=Math.random().toFixed(15).substr(5))in this.ruleByKeyMap;);this.ruleByKeyMap[s]=e,this.keyByRuleMap[e.ruleText]=s}},_rebuild:function(){this.dirty&&(this._applyExceptionRules(),this.commonCss=this._buildCssByRules(this.commonRules),this.commonCssHits=null,this.dirty=!1)},_rebuildHits:function(e){this.dirty&&(this._applyExceptionRules(),this.commonCssHits=this._buildCssByRulesHits(this.commonRules,a.Prefs.csspath+e),this.commonCss=null,this.dirty=!1)},_rebuildBinding:function(){this.dirty&&(this._applyExceptionRules(),this.commonCss=null,this.commonCssHits=null,this.dirty=!1)},_applyExceptionRules:function(){var e,s,t,i,n=this._arrayToMap(this.exceptionRules,"cssSelector");for(e=0;e<this.domainSensitiveRules.length;e++)if(i=n[(t=this.domainSensitiveRules[e]).cssSelector])for(s=0;s<i.length;s++)this._applyExceptionRule(t,i[s]);var l=[];for(e=0;e<this.commonRules.length;e++)if(i=n[(t=this.commonRules[e]).cssSelector]){for(s=0;s<i.length;s++)this._applyExceptionRule(t,i[s]);t.isDomainSensitive()&&l.push(t)}var u=this._arrayToMap(l,"ruleText");this.domainSensitiveRules=this.domainSensitiveRules.concat(l),this.commonRules=this.commonRules.filter(function(e){return!(e.ruleText in u)})},_applyExceptionRule:function(e,s){e.cssSelector==s.cssSelector&&e.addRestrictedDomains(s.getPermittedDomains())},_getCommonCss:function(){return null!=this.commonCss&&0!=this.commonCss.length||(this.commonCss=this._buildCssByRules(this.commonRules)),this.commonCss},_getCommonCssHits:function(e){return null!=this.commonCssHits&&0!=this.commonCssHits.length||(this.commonCssHits=this._buildCssByRulesHits(this.commonRules,a.Prefs.csspath+e)),this.commonCssHits},_rollbackExceptionRule:function(e){if(e.whiteListRule){var s,t,i=[];for(s=0;s<this.domainSensitiveRules.length;s++)(t=this.domainSensitiveRules[s]).cssSelector==e.cssSelector&&(t.removeRestrictedDomains(e.getPermittedDomains()),t.isDomainSensitive()||i.push(t));this.commonRules=this.commonRules.concat(i);var n=this._arrayToMap(i,"ruleText");this.domainSensitiveRules=this.domainSensitiveRules.filter(function(e){return!(e.ruleText in n)})}},_filterDomainSensitiveRules:function(e){var s,t=[];if(e){if(null!==this.domainSensitiveRules)for(var i=this.domainSensitiveRules.length;i--;)(s=this.domainSensitiveRules[i]).isPermitted(e)&&t.push(s);if(null!==this.extendedCssRules)for(var n=this.extendedCssRules.length;n--;)(s=this.extendedCssRules[n]).isPermitted(e)&&t.push(s)}return t},_buildCssByRules:function(e){for(var s=" { display: none!important; z-index:-1!important; height:0px!important;}\r\n",t=[],i=0,n=[],l=0;l<e.length;l++){var u=e[l];u.isInjectRule?n.push(this._getRuleCssSelector(u)):(t.push(this._getRuleCssSelector(u)),++i%50==0||u.extendedCss?t.push(s):t.push(", "))}0<t.length&&(t[t.length-1]=s);var r=[],o=t.join(""),h=n.join("\r\n");return o&&r.push(o),h&&r.push(h),r},_buildCssByRulesHits:function(e,s){for(var t=" { display: none!important; background-image: url('"+s+"/elemhidehit.png#",i=encodeURIComponent(";"),n=[],l=[],u=0;u<e.length;u++){var r=e[u];r.isInjectRule?l.push(this._getRuleCssSelector(r)):(n.push(this._getRuleCssSelector(r)),m.FilterUtils.isUserFilterRule(r)?n.push(" { display: none!important; }\r\n"):(n.push(t),n.push(r.filterId),n.push(i),n.push(a.BaseFilterRule.escapeRule(r.ruleText)),n.push("') !important;}\r\n")))}var o=[],h=n.join(""),c=l.join("\r\n");return h&&o.push(h),c&&o.push(c),o},_getRuleCssSelector:function(e){return n&&!e.extendedCss&&s?"::content "+e.cssSelector:t?":root "+e.cssSelector:e.cssSelector},_getDomainsSource:function(e){var s;s=e.isInjectRule?e.whiteListRule?i.MASK_CSS_EXCEPTION_INJECT_RULE:i.MASK_CSS_INJECT_RULE:e.whiteListRule?i.MASK_CSS_EXCEPTION_RULE:i.MASK_CSS_RULE;var t=e.ruleText.indexOf(s);return t<0?null:e.ruleText.substring(0,t).replace(/,~[^,]+/g,"").replace(/^~[^,]+,?/,"").toLowerCase()},_arrayToMap:function(e,s){for(var t=Object.create(null),i=0;i<e.length;i++){var n=e[i],l=n[s];l in t||(t[l]=[]),t[l].push(n)}return t}}}(yiclearAPI,vAPI);