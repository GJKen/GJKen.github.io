var YiclearAssistant=function(u){var e,o=this,a={iframeId:"yiclear-assistant-dialog",path:null,selectedElement:null,lastPreview:null,cssRuleIndex:null,urlBlockAttributes:["src","data"],urlInfo:null,croppedDomain:null},r={baseWidth:668,extendDetailedSettingsHeight:503,detailedMenuHeight:340,selectorMenuHeight:213,topOffset:25},s={getAllChilds:function(e){for(var t=[],n=e;n=s.getChildren(n);)t.push(n);return t},getChildren:function(e){var t=e.childNodes;if(t){var n,l,i=0;for(l=0;l<t.length;l++)1==t[l].nodeType&&(n=t[l],i++)}return 1==i?n:null},getParentsLevel:function(e){for(var t=e,n=[];(t=t.parentNode)&&"BODY"!=s.getNodeName(t);)n.push(t);return n},getNodeName:function(e){return e&&e.nodeName?e.nodeName.toUpperCase():""},getUrl:function(e){var t=new RegExp("^(([^:/\\?#]+):)?(//(([^:/\\?#]*)(?::([^/\\?#]*))?))?([^\\?#]*)(\\?([^#]*))?(#(.*))?$").exec(e);return{host:t[4]||"",path:t[7]||""}},cropDomain:function(e){return e.replace("www.","").replace(/:\d+/,"")}},d=function(){return a.croppedDomain||(a.croppedDomain=s.cropDomain(t().host)),a.croppedDomain},t=function(){return a.urlInfo||(a.urlInfo=s.getUrl(document.location)),a.urlInfo},f=function(e){return o.localization[e]},v=function(e){var s=h(),i=p("#drag-handle"),c=u(e.contentDocument),o=Object.create(null),a=function(e){return e||(e=window.event),{x:e.screenX,y:e.screenY}},r=function(e){e.preventDefault(),e.stopPropagation()},d=function(e){var t,n,l,i,c=a(e);t=c.x+o.x,n=c.y+o.y,(l=t)<0&&(l=0),(i=n)<0&&(i=0),s.css("left",l+"px"),s.css("top",i+"px")};i.on("mousedown",function(e){var t=a(e),n=i.get(0),l=s.get(0).getBoundingClientRect();o.x=l.left+n.offsetLeft-t.x,o.y=l.top+n.offsetTop-t.y,c.on("mousemove",d),c.on("selectstart",r)}),c.on("mouseup",function(){c.off("mousemove",d),c.off("selectstart",r)})},m=function(e,t,n){var l,i={width:window.innerWidth,height:window.innerHeight},c=(l=r.topOffset,{left:i.width-e-l,top:l}),s=document.createElement("iframe");return s.setAttribute("id",a.iframeId),s.setAttribute("class","sg_ignore yi-view-important"),s.setAttribute("frameBorder","0"),s.setAttribute("allowTransparency","true"),s.style.width=e+"px",s.style.height=t+"px",s.style.position="fixed",s.style.left=c.left+"px",s.style.top=c.top+"px",s.style.zIndex=9999,u(s).on("load",b.bind(null,s,n)),document.body.appendChild(s),s},b=function(e,s){try{var t=e.contentDocument;t.open(),t.write("<html><head></head></html>"),t.close()}catch(e){}contentPage.sendMessage({type:"loadAssistant"},function(e){e.localization&&(o.localization=e.localization);var t=e.cssContent,n=e.cssLink,l=document.getElementById(a.iframeId).contentDocument.getElementsByTagName("head")[0];if(t){var i=document.createElement("style");i.type="text/css",i.textContent=t,l.appendChild(i)}if(n){var c=document.createElement("link");c.type="text/css",c.rel="stylesheet",c.href=n,l.appendChild(c)}s.resolve()})},h=function(){return u("#"+a.iframeId)},p=function(e){return u(h().get(0).contentDocument.querySelectorAll(e))},n=function(l,e,t,i,c){var n=function(){var e,t,n;x(a,l),e=a,n=c,(t=i)&&t(e),v(e),p("body").removeClass("yi-hide"),n&&n(e),L()},s=h();if(0<s.length)return a=s.get(0),k(e,t,a),void n();var o=new Deferred;o.done(n);var a=m(e,t,o)},k=function(e,t,n){n.style.width=e+"px",n.style.height=t+"px"},x=function(e,t){for(var n=e.contentDocument.body,l=0;l<n.children.length;l++)n.removeChild(n.children[l]);n.appendChild(t.get(0)),p("body").addClass("yi-hide")},l=function(e,t){for(var n in t)u(e.contentDocument.querySelectorAll(n)).on("click",t[n])},i=function(e){e.preventDefault();var t=new Deferred;t.done(function(){D(),U(),w()}),A(t)},c=function(e){e.preventDefault(),U(),g(),_()},g=function(){YiclearSelectorLib.close()},y=function(e){a.selectedElement=e;var t=E(e),n=C(e);B(e,t,n)},_=function(){g(),h().remove()},w=function(){YiclearSelectorLib.reset(),YiclearSelectorLib.init(y)},E=function(e){var t=R(e);return t&&""!=t},C=function(e){var t=e.className;return t&&""!=t.trim()},D=function(){for(var e=p("[i18n]"),t=0;t<e.length;t++){var n=f(e[t].getAttribute("i18n"));I18nHelper.translateElement(e[t],n)}p("#blockClass").hide(),p("#blockSimilar").hide(),p("#blockByUrl").hide(),p("#oneDomainRadio").hide()},S=function(t){var e=u('<div class="main"><div class="close yi-close"></div><div class="head" id="drag-handle">\t<div i18n="assistant_block_element" class="head_title" id="head_title"></div>\t<div i18n="assistant_block_element_explain" class="head_text" id="head_text"></div></div><div class="content">\t<div class="element-rule">\t\t<div i18n="assistant_slider_explain" class="element-rule_text"></div>\t\t<div class="element-rule_slider">\t\t\t<div class="yi-slide" id="slider">\t\t\t\t<div class="yi-slide-clue-max">MAX</div>\t\t\t\t<div class="yi-slide-clue-min">MIN</div>\t\t\t</div>\t\t</div>\t\t<div class="element-rule_more">\t\t\t<span class="element-rule_expand-link" id="ExtendedSettingsText">\t\t\t\t<span i18n="assistant_extended_settings" class="element-rule_expand-link_txt"></span>\t\t\t\t<span class="element-rule_expand-link_arr"></span>\t\t\t</span>\t\t</div>\t\t<div class="element-rule_form" id="adv-settings">\t\t\t<div class="element-rule_form-cont">\t\t\t\t<div class="element-rule_fieldset" id="one-domain-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="one-domain-checkbox" type="checkbox"/>\t\t\t\t\t<label for="one-domain-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_apply_rule_to_all_sites" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-by-url-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-by-url-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-by-url-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_by_reference" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-similar-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-similar-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-similar-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_similar" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div style="display: none;" class="element-rule_fieldset" id="block-class-checkbox-block">\t\t\t\t\t<input class="form-ui-control" id="block-class-checkbox" type="checkbox"/>\t\t\t\t\t<label for="block-class-checkbox" class="form-ui">\t\t\t\t\t\t<span i18n="assistant_block_class" class="form-ui-txt"></span>\t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="element-rule_fieldset">\t\t\t\t\t<input class="form-control" id="filter-rule" type="text"/>\t\t\t\t</div>\t\t\t</div>\t\t</div>\t</div></div><div class="foot">\t<button i18n="assistant_another_element" type="button" class="btn btn-default" id="yi-cancel"></button>\t<div class="foot_action">\t\t<div class="foot_action_btn">\t\t\t<button i18n="assistant_preview" type="button" class="btn btn-primary" id="yi-preview"></button>\t\t\t<button i18n="assistant_block" type="button" class="btn btn-cancel" id="yi-accept"></button>\t\t</div>\t</div></div></div>');n(e,r.baseWidth,r.detailedMenuHeight,function(e){l(e,{"#close-button":c,".yi-close":c,"#adv-settings":W,"#yi-cancel":i,"#yi-preview":z,"#yi-accept":q,"#ExtendedSettingsText":M}),t.resolve()},function(){D()})},A=function(t){var e=u('<div class="main sg_ignore"><div class="close yi-close" id="close-button"></div><div class="head" id="drag-handle">\t<div i18n="assistant_select_element" class="head_title"></div>\t<div i18n="assistant_select_element_ext" class="head_text"></div></div><div class="foot">\t<button i18n="assistant_select_element_cancel" type="button" class="btn btn-default" id="cancel-select-mode"></button></div></div>');n(e,r.baseWidth,r.selectorMenuHeight,function(e){l(e,{"#cancel-select-mode":c,".yi-close":c}),t.resolve()},null)},B=function(e,t,n){var l=new Deferred;l.done(function(){I(e),YiclearSelectorLib.selectElement(e),W(),N(),P(t,n)}),S(l)},T=function(e,t){var n=h().get(0);t&&(n.style.height=t+"px"),e&&(n.style.width=e+"px"),L()},L=function(){var e=window.innerHeight,t=document.body.scrollTop+e,n=h().get(0),l=n.getBoundingClientRect().top+document.body.scrollTop,i=n.offsetHeight;if(t<l+i){var c=e-i-r.topOffset;c<0&&(c=r.topOffset),n.style.top=c+"px"}},M=function(){!p("#adv-settings").hasClass("open")?(T(null,r.extendDetailedSettingsHeight),p("#adv-settings").addClass("open"),p("#ExtendedSettingsText").addClass("active")):(T(null,r.detailedMenuHeight),p("#adv-settings").removeClass("open"),p("#ExtendedSettingsText").removeClass("active"))},N=function(){var e=d();p("#oneDomainText").text(e)},I=function(n){var l=s.getParentsLevel(n),i=s.getAllChilds(n),e=Math.abs(l.length+1),t=l.length+i.length+1,c={value:e,min:1,max:t};1==t&&(p("#slider").hide(),p(".element-rule_text").text(f("assistant_slider_if_hide"))),c.onSliderMove=function(e){var t;0<e&&(t=l[e-1]),0==e&&(t=n),e<0&&(t=i[Math.abs(e+1)]),Y(t)},SliderWidget.init(p("#slider").get(0),{min:c.min,max:c.max,value:c.value,onValueChanged:function(e){var t=c.value-e;c.onSliderMove(t)}})},P=function(e,t){e?p("#block-by-url-checkbox-block").show():(p("#block-by-url-checkbox").get(0).checked=!1,p("#block-by-url-checkbox-block").hide()),t?(p("#block-similar-checkbox-block").show(),p("#block-class-checkbox-block").show()):(p("#block-similar-checkbox").get(0).checked=!1,p("#block-similar-checkbox-block").hide(),p("#block-class-checkbox").get(0).checked=!1,p("#block-class-checkbox-block").hide())},Y=function(e){U(),a.selectedElement=e,YiclearSelectorLib.selectElement(e),H(),W(),P(E(e),C(e))},H=function(){p("#block-by-url-checkbox").get(0).checked=!1,p("#block-similar-checkbox").get(0).checked=!1,p("#block-class-checkbox").get(0).checked=!1,p("#one-domain-checkbox").get(0).checked=!1},R=function(e){for(var t=0;t<a.urlBlockAttributes.length;t++){var n=a.urlBlockAttributes[t],l=e.getAttribute(n);if(l)return l}return null},z=function(e){if(e&&e.preventDefault(),a.lastPreview)return U(),p("#head_title").text(f("assistant_block_element")),p("#head_text").text(f("assistant_block_element_explain")),p("#yi-preview").text(f("assistant_preview_start")),YiclearSelectorLib.selectElement(a.selectedElement),void p(".content").show();O(),p("#head_title").text(f("assistant_preview_header")),p("#head_text").text(f("assistant_preview_header_info")),p("#yi-preview").text(f("assistant_preview_end")),p(".content").hide()},O=function(){YiclearSelectorLib.reset();var e=p("#block-similar-checkbox").get(0).checked,t=YiclearRulesConstructorLib.constructCssSelector(a.selectedElement,e),n=document.createElement("style");n.setAttribute("type","text/css"),a.lastPreview=n;var l=document.getElementsByTagName("head")[0];l&&(n.appendChild(document.createTextNode(t+" {display: none !important;}")),l.appendChild(n))},U=function(){if(null!=a.lastPreview){var e=document.getElementsByTagName("head")[0];e&&e.removeChild(a.lastPreview),a.lastPreview=null}},W=function(){var e=p("#block-by-url-checkbox").get(0).checked,t=p("#block-similar-checkbox").get(0).checked,n=p("#block-class-checkbox").get(0).checked,l=p("#one-domain-checkbox").get(0).checked;P(E(a.selectedElement)&&!t,C(a.selectedElement)&&!e);var i,c={isBlockByUrl:e,urlMask:R(a.selectedElement),isBlockSimilar:t,isBlockClass:n,isBlockOneDomain:l,domain:d()},s=YiclearRulesConstructorLib.constructRuleText(a.selectedElement,c);i=s,p("#filter-rule").get(0).value=i},q=function(){U(),z(),a.lastPreview=null;var e=p("#filter-rule").get(0).value;contentPage.sendMessage({type:"addUserRule",ruleText:e},function(){_()})};e=function(){a.selectedElement&&!a.lastPreview&&YiclearSelectorLib.selectElement(a.selectedElement)},u(window).on("resize",e),u(window).on("scroll",e),this.init=function(e){o.localization=e.localization;var t=new Deferred;t.done(function(){D(),U(),w(),e.selectedElement&&e.selectedElement.click()}),A(t)},this.destroy=function(){U(),g(),_()}};