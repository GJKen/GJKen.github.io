!function(i,f){"use strict";var h=i,d=f.EventNotifier,E=f.EventNotifierTypes,u=f.CollectionUtils,s=h.FilterLSUtils;i.BlockService=function(){this.yiclearFilters=[],this.requestFilter=new h.RequestFilter,this.ApplicationUpdateService=h.ApplicationUpdateService,this.subscriptionService=new h.SubscriptionService,this.filterClasses=h.filterClasses,this.userRules=[],this.applicationFilteringDisabled=h.userSettings.isFilteringDisabled(),this._requestFilterInitTime=0,this._processFilterEvent=null},i.FilterVersion=function(e,t,i){this.timeUpdated=e,this.version=t,this.filterId=i},i.BlockService.prototype={FILTERS_CHANGE_DEBOUCE_PERIOD:1e3,RELOAD_FILTERS_DEBOUNCE_PERIOD:1e3,contentBlockerInfo:{rulesCount:0,rulesOverLimit:!1},_addAndEnableFilters:function(e,i){i=i||function(){};var r=[];if(e&&0!==e.length){var n=function(){if(0===e.length)i(r);else{var t=e.shift();this.addAntiBannerFilter(t,function(e){e&&(this.enableAntiBannerFilter(t)&&r.push(t));n()}.bind(this))}}.bind(this);n()}else i(r)},addAntiBannerFilter:function(e,t){var i=this._getFilterById(e);if(i.installed)t(!0);else{var r=function(e){e&&(i.installed=!0,s.updateFilterStateInfo(i),d.notifyListeners(E.ADD_FILTER,i)),t(e)};i.loaded?r(!0):this._loadFilterFromBackend(e,r)}},_getFilterById:function(e){for(var t=0;t<this.yiclearFilters.length;t++){var i=this.yiclearFilters[t];if(i.filterId==e)return i}throw"Filter with id "+e+" not found"},_setFilterById:function(e){for(var t=0;t<this.yiclearFilters.length;t++){if(this.yiclearFilters[t].filterId==e.filterId)return this.yiclearFilters[t]=e,!0}return!1},_loadFilterFromBackend:function(e,i){var r=f.Log,n=this._getFilterById(e);n._isDownloading=!0,d.notifyListeners(E.START_DOWNLOAD_FILTER,n);var t=function(e){r.info("Retrieved response from server for filter {0}, rules count: {1}",n.filterId,e.length),delete n._isDownloading,n.lastUpdateTime=(new Date).getTime(),n.lastCheckTime=Date.now(),n.loaded=!0,s.updateFilterStateInfo(n),s.updateFilterVersionInfo(n),d.notifyListeners(E.SUCCESS_DOWNLOAD_FILTER,n),d.notifyListeners(E.UPDATE_FILTER_RULES,n,e),i(!0)}.bind(this);this.subscriptionService.serviceClient.loadFilterRules(n.subscriptionUrl,h.userSettings.isUseOptimizedFiltersEnabled(),t,function(e,t){r.error("Error retrieved response from server for filter {0}, cause: {1} {2}",n.filterId,e.statusText,t||""),delete n._isDownloading,d.notifyListeners(E.ERROR_DOWNLOAD_FILTER,n),i(!1)})},enableAntiBannerFilter:function(e){var t=this._getFilterById(e);return!(t.enabled||!t.installed)&&(!t.enabled&&(t.enabled=!0,s.updateFilterStateInfo(t),d.notifyListeners(E.ENABLE_FILTER,t),!0))},removeAntiBannerFilter:function(e){var t=this._getFilterById(e);return"111"!=e&&(t.enabled=!1,t.installed=!1,s.updateFilterStateInfo(t),!!this._setFilterById(t)&&(d.notifyListeners(E.DISABLE_FILTER,t),d.notifyListeners(E.REMOVE_FILTER,t),!0))},disableAntiBannerFilter:function(e){var t=this._getFilterById(e);return!!t.enabled&&(t.enabled=!1,s.updateFilterStateInfo(t),d.notifyListeners(E.DISABLE_FILTER,t),!0)},initializeFiltersOnInstall:function(t){var e=function(e){this.yiclearFilters=this.filterClasses.getAllyiclearFilters(this.subscriptionService),this.yiclearFilters[2].enabled=!1,this.yiclearFilters[2].installed=!0,this.yiclearFilters[2].lastUpdateTime=(new Date).getTime(),this.yiclearFilters[2].RuleCount=e,this._addFiltersChangeEventListener(),this.enableAntiBannerFilter(this.yiclearFilters[2].filterId),t(this.yiclearFilters[2].filterId)}.bind(this);(function(){0===this.subscriptionService.getGroups().length||(i.userSettings.setProperty(i.userSettings.settings.DISABLE_AUTOUPDATE,!1),i.userSettings.setProperty(i.userSettings.settings.DISABLE_DEVELOPER,!1),i.userSettings.setProperty(i.userSettings.settings.DISABLE_SHOW_YOUKU_DANMU,!0),i.userSettings.setProperty(i.userSettings.settings.DISABLE_UPDATE_FIRSTRUN,!1),this.subscriptionService.getremoteFilterRule(e))}).bind(this)()},_createRequestFilter:function(e){var t=f.Log,i=(new Date).getTime();t.info("Starting loading filter rules from the storage");var r=Object.create(null),n=function(){t.info("Finished loading filter rules from the storage in {0} ms",(new Date).getTime()-i),this._onFiltersLoadedFromStorage(r,e)}.bind(this),s=function(t,i){var r=new f.vPromise;return h.FilterStorage.loadFilterRules(t,function(e){e&&(i[t]=e),r.resolve()}),r};(function(){for(var e=[],t=0;t<this.yiclearFilters.length;t++){var i=this.yiclearFilters[t];i.enabled&&e.push(s(i.filterId,r))}e.push(this._loadUserRulesToRequestFilter(r)),f.vPromise.all(e).then(n)}).bind(this)()},_loadUserRulesToRequestFilter:function(t){var i=new f.vPromise,r=f.AntiBannerFiltersId.USER_FILTER_ID;return h.FilterStorage.loadFilterRules(r,function(e){this.userRules=e||[],e&&(t[r]=e),i.resolve()}.bind(this)),i},_onFiltersLoadedFromStorage:function(o,e){var t=f.Log,i=(new Date).getTime(),r=h.Prefs.speedupStartup();t.info("Starting request filter initialization. Async={0}",r);var a=new h.RequestFilter,u=Object.create(null),F=function(){this.requestFilter=a,e&&"function"==typeof e&&e(),d.notifyListeners(E.REQUEST_FILTER_UPDATED,this.getRequestFilterInfo()),t.info("Finished request filter initialization in {0} ms. Rules count: {1}",(new Date).getTime()-i,a.rulesCount),0!==a.rulesCount||this.reloadedRules?0<a.rulesCount&&this.reloadedRules&&(t.info("Filters reloaded, deleting reloadRules flag"),delete this.reloadedRules):(t.info("No rules have been found - checking filter updates"),this._reloadAntiBannerFilters(),this.reloadedRules=!0)}.bind(this),l=function(e,t,i,r){var n=h.FilterRuleBuilder;if(t)for(var s=i;s<t.length&&s<r;s++){var l=t[s];if(!(l in u)){u[l]=!0;var o=n.createRule(l,e);null!==o&&a.addRule(o)}}},c=function(e,t,i,r,n){var s=new f.vPromise;return n.then(function(){setTimeout(function(){l(e,t,i,r),s.resolve()},1)}),s};r?function(){var e=new f.vPromise,t=null,i=[];for(var r in o)if((r-=0)!=f.AntiBannerFiltersId.USER_FILTER_ID)for(var n=o[r],s=0;s<n.length;s+=1e3)t=c(r,n,s,s+1e3,t||e),i.push(t);var l=o[f.AntiBannerFiltersId.USER_FILTER_ID];c(f.AntiBannerFiltersId.USER_FILTER_ID,l,0,l.length,t||e),f.vPromise.all(i).then(function(){F()}),e.resolve()}():function(){for(var e in o)if((e-=0)!=f.AntiBannerFiltersId.USER_FILTER_ID){var t=o[e];l(e,t,0,t.length)}var i=o[f.AntiBannerFiltersId.USER_FILTER_ID];l(f.AntiBannerFiltersId.USER_FILTER_ID,i,0,i.length),F()}()},getRequestFilterInfo:function(){for(var e=0,t=0,i=0,r=[],n=0;n<this.yiclearFilters.length;n++)this.yiclearFilters[n].enabled&&r.push(this.yiclearFilters[n]);return this.requestFilter&&(i=(e=this.requestFilter.rulesCount)-(t=this.requestFilter.cssFilter.commonRules.length+this.requestFilter.cssFilter.exceptionRules.length+this.requestFilter.cssFilter.domainSensitiveRules.length)),{enabledFilters:r,rulesCount:e,cssCount:t,urlCount:i}},updateContentBlockerInfo:function(e){this.contentBlockerInfo.rulesCount=e.rulesCount,this.contentBlockerInfo.rulesOverLimit=e.rulesOverLimit},modifyfiltertitle:function(e,t){var i=this._getFilterById(e);i.nickname=t;for(var r=2;r<this.yiclearFilters.length;r++)this.yiclearFilters[r].filterId==e&&(this.yiclearFilters[r].nickname=t);d.notifyListeners(E.MODIFY_FILTER,i),this.subscriptionService.updateFilterInfo(i)},isAntiBannerFilterEnabled:function(e){return this._getFilterById(e).enabled},getContentBlockerInfo:function(){return this.contentBlockerInfo},getFiltersMetadata:function(){for(var e=[],t=2;t<this.yiclearFilters.length;t++)e.push(this.yiclearFilters[t]);return e},_getUserFilterRule:function(e,t){for(var i=2;i<this.yiclearFilters.length;i++)if(this.yiclearFilters[i].subscriptionUrl==e){var r=this.yiclearFilters[i];return this.yiclearFilters[i].enabled=!1,this.yiclearFilters[i].installed=!0,r=this.yiclearFilters[i],d.notifyListeners(E.ADD_FILTER,r),d.notifyListeners(E.DISABLE_FILTER,r),this.enableAntiBannerFilter(r.filterId),void(t&&t(r))}this.subscriptionService.getUserFilterRule(e,function(e){if(e){if(!e.filterId)return t&&t("订阅组下载超时!"),void d.notifyListeners(E.ERROR_DOWNLOAD_FILTER,e);d.notifyListeners(E.ADD_FILTER,e),this.yiclearFilters.push(e),this.enableAntiBannerFilter(e.filterId),t&&t(r)}}.bind(this))},_autoUpdateFilterUrl:function(e,t){this.subscriptionService.updateFilterInfo(e),this._updateFilterUrl(e.filterId,function(){e.version=t,this.subscriptionService.updateFilterInfo(e)}.bind(this))},_updateFilterUrl:function(s,l){this.subscriptionService.updateFilterUrl(s,function(e){for(var t=0;t<this.yiclearFilters.length;t++)if(this.yiclearFilters[t].filterId==Number(s)){this.yiclearFilters[t].lastUpdateTime=e;for(var i=this.subscriptionService.getGroups(),r=0;r<i.length;r++)i[r].filterId==Number(this.yiclearFilters[t].filterId)&&(this.yiclearFilters[t].RuleCount=i[r].RuleCount,this.yiclearFilters[t].name=i[r].name||i[r].title||i[r].nickname)}var n=this._getFilterById(s);d.notifyListeners(E.SUCCESS_DOWNLOAD_FILTER,n),n.enabled=!1,d.notifyListeners(E.DISABLE_FILTER,n),n.enabled=!0,d.notifyListeners(E.ENABLE_FILTER,n),l(e)}.bind(this))},getEnabledAntiBannerFilters:function(){return this.yiclearFilters.filter(function(e){return e.installed&&e.enabled&&e.filterId!=f.AntiBannerFiltersId.USER_FILTER_ID&&e.filterId!=f.AntiBannerFiltersId.WHITE_LIST_FILTER_ID})},addAndEnableFilter:function(e){this._addAndEnableFilters([e])},addUserFilterRule:function(e){var t=h.FilterRuleBuilder.createRule(e,f.AntiBannerFiltersId.USER_FILTER_ID);null!==t&&(this._addRuleToFilter(f.AntiBannerFiltersId.USER_FILTER_ID,t),this.userRules.push(t.ruleText)),d.notifyListeners(E.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},addUserFilterRules:function(e){for(var t=h.FilterRuleBuilder,i=[],r=0;r<e.length;r++){var n=t.createRule(e[r],f.AntiBannerFiltersId.USER_FILTER_ID);null!==n&&(i.push(n),this.userRules.push(n.ruleText))}return this._addRulesToFilter(f.AntiBannerFiltersId.USER_FILTER_ID,i),d.notifyListeners(E.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo()),i},_addRuleToFilter:function(e,t){var i=this._getFilterById(e);this.requestFilter.addRule(t),d.notifyListeners(E.ADD_RULE,i,[t])},_addRulesToFilter:function(e,t){var i=this._getFilterById(e);this.requestFilter.addRules(t),d.notifyListeners(E.ADD_RULES,i,t)},removeUserFilter:function(e){var t=h.FilterRuleBuilder.createRule(e,f.AntiBannerFiltersId.USER_FILTER_ID);if(null!==t){var i=this._getFilterById(f.AntiBannerFiltersId.USER_FILTER_ID);this.requestFilter.removeRule(t),d.notifyListeners(E.REMOVE_RULE,i,[t])}u.removeAll(this.userRules,e),d.notifyListeners(E.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},init:function(t){var e=this,i=this.ApplicationUpdateService.getRunInfo(),r=function(e){0===this._requestFilterInitTime&&(this._requestFilterInitTime=(new Date).getTime()),t.runCallback&&t.runCallback(e)}.bind(this),n=function(){h.whiteListService.initWhiteListFilters(),e._createRequestFilter(function(){this._addFiltersChangeEventListener(),r(i)}.bind(this))}.bind(this),s=function(){this._subscribeToFiltersChangeEvents(),i.isFirstRun?r(i):(this.yiclearFilters=this.filterClasses.getAllyiclearFilters(this.subscriptionService),n())}.bind(this);this.subscriptionService.init(s)},_subscribeToFiltersChangeEvents:function(){var i=f.platformUtils.debounce(this._reloadAntiBannerFilters.bind(this),this.RELOAD_FILTERS_DEBOUNCE_PERIOD);d.addListener(function(e,t){e!==E.CHANGE_USER_SETTINGS||t!==h.userSettings.settings.USE_OPTIMIZED_FILTERS?(e==E.CHANGE_USER_SETTINGS&&t==h.userSettings.settings.DISABLE_COLLECT_HITS||e==E.CHANGE_PREFS&&"use_global_style_sheet"==t)&&(this.getRequestFilter().cssFilter.dirty=!0):i()}.bind(this))},_reloadAntiBannerFilters:function(){this._resetFiltersVersion()},_resetFiltersVersion:function(){},isApplicationFilteringDisabled:function(){return this.applicationFilteringDisabled},isRequestFilterReady:function(){return 0<this._requestFilterInitTime},shouldCollapseAllElements:function(){return 0<this._requestFilterInitTime&&this._requestFilterInitTime+3e3>(new Date).getTime()},getRequestFilter:function(){return this.requestFilter},getUserFilters:function(e,t,i){for(var r=f.StringUtils,n=this.userRules,s=[],l=0;l<n.length;l++){var o=n[l];i&&!r.containsIgnoreCase(o,i)||s.push(o)}return t?s.slice(e,e+t):s},clearUserFilter:function(){this.userRules=[];var e=this._getFilterById(f.AntiBannerFiltersId.USER_FILTER_ID);d.notifyListeners(E.UPDATE_FILTER_RULES,e,[]),d.notifyListeners(E.UPDATE_USER_FILTER_RULES,this.getRequestFilterInfo())},whiteListFrame:function(e){h.whiteListService.whiteListUrl(e.url),d.notifyListeners(E.UPDATE_WHITELIST_FILTER_RULES)},unWhiteListFrame:function(e){e.frameRule&&(h.whiteListService.unWhiteListUrl(e.url),d.notifyListeners(E.UPDATE_WHITELIST_FILTER_RULES))},getWhiteListDomains:function(e,t,i){for(var r=f.StringUtils,n=h.whiteListService.getWhiteList(),s=[],l=0;l<n.length;l++){var o=n[l];i&&!r.containsIgnoreCase(o,i)||s.push(o)}return t?s.slice(e,e+t):s},addWhiteListDomain:function(e){h.whiteListService.addToWhiteList(e),d.notifyListeners(E.UPDATE_WHITELIST_FILTER_RULES)},addWhiteListDomains:function(e){h.whiteListService.addToWhiteListArray(e),d.notifyListeners(E.UPDATE_WHITELIST_FILTER_RULES)},removeWhiteListDomain:function(e){h.whiteListService.removeFromWhiteList(e),d.notifyListeners(E.UPDATE_WHITELIST_FILTER_RULES)},clearWhiteListFilter:function(){h.whiteListService.clearWhiteList(),d.notifyListeners(E.UPDATE_WHITELIST_FILTER_RULES)},_addFiltersChangeEventListener:function(){var u=[],F=null,r=function(e,t,i){u.push({event:e,filter:t,rules:i}),null!==F&&clearTimeout(F),F=setTimeout(function(){var e=u.slice(0);u=[],F=null;for(var t=e.some(function(e){return 0<=c.indexOf(e.event)}),i=Object.create(null),r=0;r<e.length;r++){var n=e[r];n.filter.filterId in i||(i[n.filter.filterId]=[]),i[n.filter.filterId].push(n)}var s=[],l=function(e){return 0<=I.indexOf(e.event)};for(var o in i){if(i[o].some(l)){var a=this._processSaveFilterRulesToFSEvents(o,i[o]);s.push(a)}}t?f.vPromise.all(s).then(this._createRequestFilter.bind(this)):d.notifyListeners(E.REQUEST_FILTER_UPDATED,this.getRequestFilterInfo())}.bind(this),this.FILTERS_CHANGE_DEBOUCE_PERIOD)}.bind(this);d.addListener(function(e,t,i){switch(e){case E.ADD_RULE:case E.ADD_RULES:case E.REMOVE_RULE:case E.UPDATE_FILTER_RULES:case E.ENABLE_FILTER:case E.DISABLE_FILTER:r(e,t,i)}})},_processSaveFilterRulesToFSEvents:function(l,o){var a=new f.vPromise;return h.FilterStorage.loadFilterRules(l,function(e){for(var t=0;t<o.length;t++){e||(e=[]);var i=o[t],r=i.event,n=i.rules;switch(r){case E.ADD_RULE:case E.ADD_RULES:e=e.concat(u.getRulesText(n));break;case E.REMOVE_RULE:var s=n[0];u.removeAll(e,s.ruleText);break;case E.UPDATE_FILTER_RULES:e=u.getRulesText(n)}}h.FilterStorage.saveFilterRules(l,e,a.resolve)}.bind(this)),a}};var c=[E.UPDATE_FILTER_RULES,E.ENABLE_FILTER,E.DISABLE_FILTER],I=[E.UPDATE_FILTER_RULES,E.ADD_RULE,E.ADD_RULES,E.REMOVE_RULE]}(yiclearAPI,vAPI),function(){var e=vAPI.EventNotifier;yiclearAPI.UI,vAPI.platformUtils;e.addListener(function(e,t,i){e==vAPI.EventNotifierTypes.UPDATE_FILTERS_SHOW_POPUP&&(yiclearAPI.UI.showAlertMessagePopup(i.title,i.version),console.log("123"))})}();