!function(a,s){"use strict";function c(i,t){var e=function(i,t){if(!i||!i.childNodes)return null;for(var e=i.childNodes,r=0;r<e.length;r++){var n=e[r];if(n.localName==t)return n}return null}(i,t);return e?e.textContent:null}a.SubscriptionService=function(){var i=a.ClientService;this.serviceClient=new i,this.groups=[],this.filters=[]},a.SubscriptionService.prototype={init:function(i){var e=s.Log,t=this.find();if(t)this.groups=t,i();else{var r=new s.vPromise;this.serviceClient.loadYiclearSubscriptions(function(i){this.groups=i,r.resolve()}.bind(this),n),s.vPromise.all([r]).then(function(){this.setLS(JSON.stringify(this.groups)),i()}.bind(this))}var n=function(i,t){e.error("Error loading metadata, cause: {0} {1}",i.statusText,t)}},setLS:function(i){s.LocalStorage.setItem("yiclear-groups",i)},find:function(){var i=s.LocalStorage.getItem("yiclear-groups");return i?JSON.parse(i):null},getUserFilterRule:function(n,s){for(var i=this.find(),t=0;t<i.length;t++)if(i[t].subscriptionUrl==n)return void s();var e=function(i){var t=a.FilterStorage,e=a.SubscriptionFilter.formTxt(i),r=this.groups.length;e.filterId=this.groups[r-1].filterId+1,e.subscriptionUrl=n,e.installed=!0,this.groups.push(e),this.setLS(JSON.stringify(this.groups)),t.saveFilterRules(e.filterId,i,function(){s(e)}.bind(this))}.bind(this);this.serviceClient.loadFilterRulesBySubscriptionUrl(n,e,function(i){s(i)})},updateFilterInfo:function(i){for(var t=this.find(),e=0;e<t.length;e++)t[e].filterId==i.filterId&&(t[e]=i);this.setLS(JSON.stringify(t))},updateFilterUrl:function(i,n){for(var t=this.find(),s=null,l=null,e=0;e<t.length;e++)t[e].filterId==i&&(l=t[e].filterId,s=t[e].subscriptionUrl);var r=function(i){var t=a.FilterStorage,e=a.SubscriptionFilter.formTxt(i);e.filterId=l,e.subscriptionUrl=s;for(var r=0;r<this.groups.length;r++)e.filterId==this.groups[r].filterId&&(e.installed=!0,void 0!==e.nickname&&null!==e.nickname||(e.nickname=this.groups[r].nickname),this.groups[r]=e);this.setLS(JSON.stringify(this.groups)),t.saveFilterRules(l,i,function(){n((new Date).getTime())}.bind(this))}.bind(this);null!==s&&(0==s.indexOf("local/")&&(s=s.replace("local/","http://tools.yiclear.com/")),this.serviceClient.loadFilterRulesBySubscriptionUrl(s,r))},getremoteFilterRule:function(i){var n=0,t=function(i,e,t){var r=new s.vPromise;return i.loadFilterRulesBySubscriptionUrl(t,function(i){var t=a.FilterStorage;n=i.length,t.saveFilterRules(e,i,null),r.resolve()},null),r}.bind(this);if(0!==this.groups.length){for(var e=[],r=0;r<this.groups.length;r++)e.push(t(this.serviceClient,this.groups[r].filterId,this.groups[r].subscriptionUrl));s.vPromise.all(e).then(function(){i(n)})}},getGroups:function(){return this.groups}},a.SubscriptionFilter=function(i,t,e,r,n,s,l,o,u,a){this.filterId=i,this.title=t,this.specialization=e,this.subscriptionUrl=r,this.homepage=n,this.prefixes=s,this.author=l,this.lastUpdateTime=o,this.RuleCount=u,this.version=a},a.SubscriptionFilter.formTxt=function(i){var t=a.SubscriptionFilter,e=function(i){for(var t=i,e=null,r=null,n=null,s=null,l=null,o=0;o<20;o++){var u=t[o];/!\s+Version:\s+([0-9.]+)/i.test(u)?e=e||RegExp.$1:/!\s+Homepage:\s+(.+)$/i.test(u)?r=r||RegExp.$1:/!\s+Title:\s+(.+)$/i.test(u)?n=n||RegExp.$1:/!\s+Specialization:\s+(.+)$/i.test(u)?s=s||RegExp.$1:/!\s+Email:\s+(.+)$/i.test(u)&&(l=l||RegExp.$1)}return{title:n,version:e,homepage:r,Specialization:s,Email:l,nickname:null}}(i),r=e.title,n=e.specialization,s=e.homepage,l=e.Email,o=e.version;return new t(0,r,n,null,s,null,l,(new Date).getTime(),i.length,o)},a.SubscriptionFilter.fromXml=function(i){var t=a.SubscriptionFilter,e=c(i,"title"),r=c(i,"specialization"),n=c(i,"url"),s=c(i,"homepage"),l=c(i,"prefixes"),o=c(i,"author"),u=c(i,"version");return new t(0,e,r,n,s,l,o,(new Date).getTime(),i.length,u)}}(yiclearAPI,vAPI);