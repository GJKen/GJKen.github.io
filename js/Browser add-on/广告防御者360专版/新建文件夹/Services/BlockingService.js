!function(e,l){"use strict";var o=e,c=l,n=c.platformUtils.isShadowDomSupported(),a=34<c.ext.app.getBrowserVersion();e.WebRequestService=function(e,t,i,s){this.framesMap=e,this.antiBannerService=t,this.filteringLog=i,this.YiclearApplication=s,this.processRequestResponse=function(e,t,i,s,r){s==c.RequestTypes.DOCUMENT&&(this.YiclearApplication.checkHeaders(e,r,t),this.filteringLog.clearEventsForTab(e));var l=null,n=!1;if(this.framesMap.isTabyiclearDetected(e))l=this.YiclearApplication.parseYiclearRuleFromHeaders(r);else if(this.framesMap.isTabProtectionDisabled(e));else if(s==c.RequestTypes.DOCUMENT){l=this.framesMap.getFrameWhiteListRule(e);var a=this.framesMap.getFrameDomain(e);this.framesMap.isIncognitoTab(e)||o.filterRulesHitCount.addDomainView(a),n=!0}n&&this.filteringLog.addEvent(e,t,i,s,l)},this.filteringLogEventUpdate=function(e,t,i,s){this.filteringLog.updateEvent(e,t,s)},this.processGetSelectorsAndScripts=function(e,t,i){var s=Object.create(null);if(!e)return s;if(!this.antiBannerService.isRequestFilterReady())return s.requestFilterReady=!1,s;if(this.framesMap.isTabyiclearDetected(e)||this.framesMap.isTabProtectionDisabled(e)||this.framesMap.isTabWhiteListed(e))return s;s={selectors:null,scripts:null,collapseAllElements:this.antiBannerService.shouldCollapseAllElements(),useShadowDom:!!n||a};var r=this.antiBannerService.getRequestFilter().findWhiteListRule(t,t,"GENERICHIDE");(this.antiBannerService.getRequestFilter().findWhiteListRule(t,t,"ELEMHIDE")||(this.shouldLoadAllSelectors(s.collapseAllElements)?s.selectors=this.antiBannerService.getRequestFilter().getSelectorsForUrl(t,r):s.selectors=this.antiBannerService.getRequestFilter().getInjectedSelectorsForUrl(t,r)),0<=i.filter.indexOf("scripts"))&&(this.antiBannerService.getRequestFilter().findWhiteListRule(t,t,"JSINJECT")||(s.scripts=this.antiBannerService.getRequestFilter().getScriptsForUrl(t)));return s},this.checkPageScriptWrapperRequest=function(e,t,i,s){if(!e)return!1;var r=this.getRuleForRequest(e,t,i,s);return this.filteringLog.addEvent(e,t,i,s,r),this.isRequestBlockedByRule(r)},this.getBlockedResponseByRule=function(e){return this.isRequestBlockedByRule(e)?e.emptyResponse?{redirectUrl:l.ext.getURL("elemhidehit.png")}:{cancel:!0}:null},this.getCspRules=function(e,t,i,s){if(this.framesMap.isTabyiclearDetected(e)||this.framesMap.isTabProtectionDisabled(e)||this.framesMap.isTabWhiteListed(e))return null;var r=this.antiBannerService.getRequestFilter().findWhiteListRule(t,i,l.RequestTypes.DOCUMENT);return r&&r.checkContentTypeIncluded("DOCUMENT")?null:this.antiBannerService.getRequestFilter().getCspRules(t,i,s)},this.shouldLoadAllSelectors=function(e){var t=c.platformUtils,i=o.userSettings;if(t.isFirefoxBrowser()&&i.collectHitsCount()||o.Prefs.useGlobalStyleSheet)return!1;var s=t.isContentBlockerEnabled();return!(!s||!e)||!s},this.processShouldCollapseMany=function(e,t,i){if(!e)return i;for(var s=0;s<i.length;s++){var r=i[s],l=this.getRuleForRequest(e,r.elementUrl,t,r.requestType);r.collapse=this.isRequestBlockedByRule(l)}return i},this.processShouldCollapse=function(e,t,i,s){if(!e)return!1;var r=this.getRuleForRequest(e,t,i,s);return this.isRequestBlockedByRule(r)},this.isRequestBlockedByRule=function(e){return e&&!e.whiteListRule},this.getRuleForRequest=function(e,t,i,s){if(this.framesMap.isTabyiclearDetected(e)||this.framesMap.isTabProtectionDisabled(e))return null;return this.framesMap.isTabWhiteListed(e)?this.framesMap.getFrameWhiteListRule(e):"DOCUMENT"===s?this.antiBannerService.getRequestFilter().findRuleForRequest(t,i,"REDIRECT"):this.antiBannerService.getRequestFilter().findRuleForRequest(t,i,s)},this.postProcessRequest=function(e,t,i,s,r){var l=c.EventNotifier;if(!this.framesMap.isTabyiclearDetected(e)){this.isRequestBlockedByRule(r)&&l.notifyListeners(c.EventNotifierTypes.ADS_BLOCKED,r,e,1),this.filteringLog.addEvent(e,t,i,s,r);var n=c.FilterUtils,a=o.filterRulesHitCount;if(r&&!n.isUserFilterRule(r)&&!n.isWhiteListFilterRule(r)&&!this.framesMap.isIncognitoTab(e)){var u=this.framesMap.getFrameDomain(e);a.addRuleHit(u,r.ruleText,r.filterId,t)}}}}}(yiclearAPI,vAPI);