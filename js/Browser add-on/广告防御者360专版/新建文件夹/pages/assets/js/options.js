var yiclearPage=self.yiclearPage=self.yiclearPage||{};yiclearPage.optionsController=function(){},yiclearPage.defaultID=111,yiclearPage.optionsController.prototype={DEFAULT_LIMIT:20,omitRenderEventsCount:0,linkHelper:null,SUBSCRIPTIONS_LIMIT:9,init:function(){this.linkHelper=document.createElement("a"),this._bindEvents()},showPageStatisticsChange:function(){contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_PAGE_STATS,value:!this.checked})},_bindEvents:function(){this.block_body_filters=$("#options-filters"),this.block_body_userRules=$("#options-userRules"),this.block_body_passDomain=$("#options-passDomain"),this.block_body_settings=$("#options-settings"),this.importUserFilterInput=$("#importUserFilterInput"),this.importWhiteListFilterInput=$("#importWhiteListFilterInput"),this.importConfigInput=$("#importConfigInput"),this.block_body_filters_input=$("#user-filter-search"),this.block_body_filters_list=$("#options-userRules select"),this.block_body_filters_clear=$("#clearUserFilter"),this.version=$("#version"),this.spread=$("#spread"),this.version.text("版本："+environmentOptions.Prefs.version),this._renderUserFilters(),this._renderWhiteDomains(),this._renderBlockFilters(),this._rebderSettings(),this._rebderSpread(),$("#importUserFilter").on("click",this.onImportUserFilterClicked.bind(this)),this.importUserFilterInput.on("change",this.onImportUserFilterInputChange.bind(this)),$("#importWhiteListFilter").on("click",this.onImportWhiteListFilterClicked.bind(this)),this.importWhiteListFilterInput.on("change",this.onImportWhiteListFilterInputChange.bind(this)),$("#importConfig").on("click",this.onImportConfigClicked.bind(this)),this.importConfigInput.on("change",this.onImportConfigInputChange.bind(this)),this._onbind(),this._initSearch(this.block_body_filters_input,this.block_body_filters_list,this._renderUserFilters),this.block_body_filters_input.focus(function(){$("#filter_search_underline").height(2);var e=0,t=setInterval(function(){$("#filter_search_underline").width(e+"%"),100<(e+=5)&&clearInterval(t)},10)}),this.block_body_filters_input.blur(function(){var e=100,t=setInterval(function(){$("#filter_search_underline").width(e+"%"),(e-=5)<0&&(clearInterval(t),$("#filter_search_underline").height(0))},10)}),$("#user-pass-search").focus(function(){$("#pass_search_underline").height(2);var e=0,t=setInterval(function(){$("#pass_search_underline").width(e+"%"),100<(e+=5)&&clearInterval(t)},10)}),$("#user-pass-search").blur(function(){var e=100,t=setInterval(function(){$("#pass_search_underline").width(e+"%"),(e-=5)<0&&(clearInterval(t),$("#pass_search_underline").height(0))},10)})},_onbind:function(){$("#user-filter-search").bind("keypress",this._onuserfilterInput),$("#user-pass-search").bind("keypress",this._onpassdomainInput),$("#options-userRules  .button-options").bind("click",function(){if("删除选中项"==$(this).text()){var e=$("#options-userRules select").find("option:selected");if(0<e.length){for(var t=0;t<e.length;t++)""!=e[t].text&&contentPage.sendMessage({type:"removeUserFilter",text:e[t].text},function(e){});$("#user-filter-search").val("")}}}),$("#modifyfilter .button-small").bind("click",function(){console.log(this);var e=$(this).attr("aria-controls"),t=$("#modifyfilter input").val().replace(/[\r\n]/g,"");void 0!==t&&(contentPage.sendMessage({type:"modifyfilter",filterId:e,name:t}),$("#modifyfilter").modal("hide"))}),$("#addfilterModal .button-small").bind("click",function(){var e=$("#addfilterModal input").val().replace(/[\r\n]/g,"");"http://"!=e&&"http://"!=e&&""!=e&&(contentPage.sendMessage({type:"addfilterUrl",url:e}),$("#addfilterModal").modal("hide"),$("#filterupdate").modal("show"),$("#filterupdate h4").text("订阅组添加中..."))}),$("#addfilterModal a").bind("click",function(e){var t=e.target.text,i=$("#addfilterModal input");"国内网站规则"==t?i.val("https://easylist-downloads.adblockplus.org/easylistchina.txt"):"国外网站规则"==t?i.val("https://easylist.to/easylist/easylist.txt"):"恶意软件规则"==t?i.val("https://easylist-downloads.adblockplus.org/malwaredomains_full.txt"):"baidu美化规则"==t?i.val("http://tools.yiclear.com/baidu-lite.txt"):"卡饭论坛{乘风}规则"==t?i.val("https://raw.githubusercontent.com/xinggsf/Adblock-Plus-Rule/master/ABP-FX.txt"):"Fanboy's规则"==t&&i.val("https://fanboy.co.nz/r/fanboy-ultimate.txt")}),$("#addfilterModal").on("show.bs.modal",function(e){$(this).find(".modal-body input").val("http://")});var i=[];$(".row.tableHeader").on("click","a",function(){for(var e=$("#options-filters .tablebody").find("a"),t=0;t<e.length;t++)"更新"==$(e[t]).text()&&(i.push($(e[t]).attr("aria-controls")),progressUI($(e[t]).attr("aria-controls"),!0),contentPage.sendMessage({type:"updatefilterUrl",filterId:$(e[t]).attr("aria-controls")}))}),$("#options-filters .tablebody").on("click","a",function(){var e=$(this).attr("aria-controls"),t=$(this).text();if("删除"==t)Number(e)!=yiclearPage.defaultID?contentPage.sendMessage({type:"removeBlockFilter",filterId:e}):($("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),$("#filterupdate h4").text("默认规则不能删除！"));else if("启动"==t)progressUI(e,!0),contentPage.sendMessage({type:"enableBlockFilter",filterId:e});else if("停止"==t)progressUI(e,!0),contentPage.sendMessage({type:"disableBlockFilter",filterId:e});else if("更新"==t)progressUI(e,!0),contentPage.sendMessage({type:"updatefilterUrl",filterId:e});else if("备注"==t)$("#modifyfilter").modal({keyboard:!1}),$("#modifyfilter").modal("show"),$("#modifyfilter .button-small").attr("aria-controls",e);else if("地址"==t){var i=$(this).attr("aria-label");$("#addfilterModal").modal("hide"),$("#filterupdate").modal("show"),$("#filterupdate h4").text(i)}}),$("#options-userRules .button-link").bind("click",function(){var e=$(this).text();"清空"==e?contentPage.sendMessage({type:"clearUserFilter"}):"导出"==e&&contentPage.sendMessage({type:"openExportRulesTab",filename:"rules.txt"})}),$("#options-userRules select").bind("click",function(){var e=$("#options-userRules select").find("option:selected").text();$("#user-filter-search").val(e)}),$("#options-passDomain select").bind("click",function(){var e=$("#options-passDomain select").find("option:selected").text();$("#user-pass-search").val(e)}),$("#options-passDomain  .button-options").bind("click",function(){if("删除选中项"==$(this).text()){var e=$("#options-passDomain select").find("option:selected");if(0<e.length)for(var t=0;t<e.length;t++)""!=e[t].text&&contentPage.sendMessage({type:"removeWhiteListDomain",text:e[t].text})}}),$("#options-passDomain .button-link").bind("click",function(){var e=$(this).text();"清空"==e?contentPage.sendMessage({type:"clearWhiteListFilter"}):"导出"==e&&contentPage.sendMessage({type:"openExportRulesTab",filename:"whitelist.txt"})}),$(".options-css-checkbox-input").bind("change",function(){var e=$(this).is(":checked"),t=$(this).attr("id");"autoupdate"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_AUTOUPDATE,value:!e}):"shouldShowBlockElementMenu"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_CONTEXT_MENU,value:!e}):"shouldShowBlock"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_ICON_BLOCK,value:!e}):"Developer"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_DEVELOPER,value:!e}):"YoukuDanmu"==t?contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_SHOW_YOUKU_DANMU,value:!e}):"UpdateFirstRun"==t&&contentPage.sendMessage({type:"changeUserSetting",key:userSettings.names.DISABLE_UPDATE_FIRSTRUN,value:!e}),console.log(t)}),$("#options-settings .button").bind("click",function(){var e=$(this).text();"清空"==e?(contentPage.sendMessage({type:"resetBlockedAdsCount"}),contentPage.sendMessage({type:"getBlockedCount"},function(e){$("#options-block-count").text("广告过滤数："+e.BlockedCount)})):"备份"==e&&contentPage.sendMessage({type:"openExportRulesTab",filename:"config.txt"})}),$("#options-help a").bind("click",function(){var e=$(this).text();"查看"==e?contentPage.sendMessage({type:"openissue"}):"反馈"==e&&contentPage.sendMessage({type:"openfeedback"})})},_importWhiteListFilterRules:function(e){var t=e?e.split(/[\r\n]+/):[];contentPage.sendMessage({type:"addWhiteListDomains",domains:t})},onImportWhiteListFilterInputChange:function(){var t=this.importWhiteListFilterInput[0],e=new FileReader;e.onload=function(e){try{this._importWhiteListFilterRules(e.target.result)}catch(e){Log.error("Error while loading whitelist rules {0}",e)}t.value=""}.bind(this),e.onerror=function(){Log.error("Error load whitelist rules"),t.value=""};var i=t.files[0];i&&e.readAsText(i,"utf-8")},onImportWhiteListFilterClicked:function(e){this.importWhiteListFilterInput.trigger("click")},onImportConfigClicked:function(e){this.importConfigInput.trigger("click")},_importConfigsRules:function(e){contentPage.sendMessage({type:"setConfigs",configs:e})},onImportConfigInputChange:function(){var t=this.importConfigInput[0],e=new FileReader;e.onload=function(e){try{this._importConfigsRules(e.target.result)}catch(e){Log.error("Error while loading whitelist rules {0}",e)}t.value=""}.bind(this),e.onerror=function(){Log.error("Error load whitelist rules"),t.value=""};var i=t.files[0];i&&e.readAsText(i,"utf-8")},onImportUserFilterClicked:function(e){this.importUserFilterInput.trigger("click")},_importUserFilterRules:function(e){var t=e?e.split(/[\r\n]+/):[];contentPage.sendMessage({type:"addUserFilterRules",rules:t})},onImportUserFilterInputChange:function(){var t=this.importUserFilterInput[0],e=new FileReader;e.onload=function(e){try{this._importUserFilterRules(e.target.result)}catch(e){Log.error("Error while loading user rules {0}",e)}t.value=""}.bind(this),e.onerror=function(){Log.error("Error load user rules"),t.value=""};var i=t.files[0];i&&e.readAsText(i,"utf-8")},_onBlockFilterStateChange:function(e){this._modifyFilters(e),progressUI(e.filterId,!1)},_onpassdomainInput:function(e){if("13"==e.keyCode){var t=$("#user-pass-search").val().trim().replace(/[\r\n\t]/g,"");contentPage.sendMessage({type:"addWhiteListDomain",text:t})}},_onuserfilterInput:function(e){if("13"==e.keyCode){var t=$("#user-filter-search").val().trim().replace(/[\r\n\t]/g,"");contentPage.sendMessage({type:"addUserFilterRule",text:t}),$("#user-filter-search").val("")}},_renderWhiteDomains:function(){var n=this.block_body_passDomain.find("select");n.empty(),contentPage.sendMessage({type:"getWhiteListDomains"},function(e){for(var t=0;t<e.rules.length;t++){var i=$("<option>").val(1).text(e.rules[t]);n.append(i)}}.bind(this))},_initSearch:function(e,i,n){e.on("keyup",this._debounce(n.bind(this),300)),i.scroll(function(){var e=i.height(),t=i.get(0).scrollHeight;.95<=i.scrollTop()/(t-e)&&n.call(this,!0)}.bind(this))},_renderSearchFilters:function(e,n,t,s,r,i,o){if((o=!0===o)||(s.offset=0,s.allLoaded=!1),!this._isLoading&&!s.allLoaded){var a=e.val().trim();s.searchMode=0<a.length,contentPage.sendMessage({type:i,offset:s.offset,limit:s.limit,text:a},function(e){var t=e.rules;t.length<s.limit&&(s.allLoaded=!0),s.offset+=t.length,s._isLoading=!1,o||n.empty();for(var i=0;i<t.length;i++)r.call(this,t[i])}.bind(this))}},_renderUserFilter:function(e){var t=$("<option>").val(1).text(e);this.block_body_filters_list.append(t)},_renderUserFilters:function(e){this.userSearchResult||(this.userSearchResult={offset:0,limit:this.DEFAULT_LIMIT,allLoaded:!1}),this._renderSearchFilters(this.block_body_filters_input,this.block_body_filters_list,this.block_body_filters_clear,this.userSearchResult,this._renderUserFilter,"getUserFilters",e)},_renderBlockFilters:function(){$("#filterupdate").modal("hide");var e=this.block_body_filters.find(".tablebody");e.empty();for(var t=0;t<filtersMetadata.length;t++)filtersMetadata[t].installed&&(filtersMetadata[t].name=filtersMetadata[t].name||filtersMetadata[t].title||filtersMetadata[t].nickname,e.append(filters_template(filtersMetadata[t].filterId,filtersMetadata[t].name,filtersMetadata[t].lastUpdateTime,filtersMetadata[t].RuleCount,filtersMetadata[t].subscriptionUrl)))},_rebderSpread:function(){contentPage.sendMessage({type:"getSpread"},function(e){var t=e.spreadData;this.spread.html(t)}.bind(this))},_rebderSettings:function(){var e=userSettings.values[userSettings.names.DISABLE_AUTOUPDATE],t=userSettings.values[userSettings.names.DISABLE_SHOW_CONTEXT_MENU],i=userSettings.values[userSettings.names.DISABLE_SHOW_ICON_BLOCK],n=userSettings.values[userSettings.names.DISABLE_DEVELOPER],s=userSettings.values[userSettings.names.DISABLE_SHOW_YOUKU_DANMU],r=userSettings.values[userSettings.names.DISABLE_PROXY],o=userSettings.values[userSettings.names.DISABLE_UPDATE_FIRSTRUN];$("#shouldShowBlockElementMenu").attr("checked",!t),$("#autoupdate").attr("checked",!e),$("#shouldShowBlock").attr("checked",!i),$("#Developer").attr("checked",!n),$("#YoukuDanmu").attr("checked",!s),$("#Proxy").attr("checked",!r),$("#UpdateFirstRun").attr("checked",!o),$("#options-block-count").text("广告过滤数："+blockCount)},_delFilters:function(e){$("#filters-"+e.filterId).remove()},_addFilters:function(e){var t=this.block_body_filters.find(".tablebody");if(0<$("#filters-"+e.filterId+" .col-xs-4:first").length)return $("#filterupdate").modal({keyboard:!1}),$("#filterupdate").modal("show"),void $("#filterupdate h4").text("订阅组已存在!");$("#filterupdate").modal("hide"),e.name=e.name||e.title||e.nickname,t.append(filters_template(e.filterId,e.name,e.lastUpdateTime,e.RuleCount,e.subscriptionUrl))},_modifyFilters:function(e){e.name=e.name||e.title||e.nickname,$("#filters-"+e.filterId+" .col-xs-4:first").text(e.name),$("#filters-"+e.filterId+" .col-xs-4:last").text("["+new Date(e.lastUpdateTime).Format("yyyy-MM-dd hh:mm:ss")+"]规则数:"+e.RuleCount),e.enabled?($("#filters-"+e.filterId+" .col-xs-3 .btn-group a:first").text("停止"),$("#filters-"+e.filterId+" .col-xs-3 .btn-group a:first").addClass("button-red")):($("#filters-"+e.filterId+" .col-xs-3 .btn-group a:first").text("启动"),$("#filters-"+e.filterId+" .col-xs-3 .btn-group a:first").removeClass("button-red"))},_errordownload:function(e){$("#filterupdate").modal("show"),$("#filterupdate h4").text("订阅组添加发生错误!")},renderFilterRulesInfo:function(e){enabledFilters=[];for(var t=0;t<e.enabledFilters.length;t++)enabledFilters[e.enabledFilters[t].filterId]=!0,filtersMetadata.enabled=!0;contentPage.sendMessage({type:"getfiltersmetadata"},function(e){filtersMetadata=e.metadata,this._renderBlockFilters()}.bind(this))},_debounce:function(i,n){var s;return function(){var e=this,t=arguments;clearTimeout(s),s=setTimeout(function(){s=null,i.apply(e,t)},n)}}};var blockCount,userSettings,enabledFilters,environmentOptions,AntiBannerFiltersId,EventNotifierTypes,requestFilterInfo,contentBlockerInfo,filtersMetadata,listenerId=null,onUnload=function(){listenerId&&(contentPage.sendMessage({type:"removeListener",listenerId:listenerId}),listenerId=null)};contentPage.sendMessage({type:"initializeFrameScript"},function(e){blockCount=e.BlockedCount,userSettings=e.userSettings,enabledFilters=e.enabledFilters,environmentOptions=e.environmentOptions,requestFilterInfo=e.requestFilterInfo,contentBlockerInfo=e.contentBlockerInfo,filtersMetadata=e.filtersMetadata,AntiBannerFiltersId=e.constants.AntiBannerFiltersId,EventNotifierTypes=e.constants.EventNotifierTypes,$(document).ready(function(){var i=new yiclearPage.optionsController;i.init();var t,e=[EventNotifierTypes.ENABLE_FILTER,EventNotifierTypes.DISABLE_FILTER,EventNotifierTypes.ADD_FILTER,EventNotifierTypes.REMOVE_FILTER,EventNotifierTypes.MODIFY_FILTER,EventNotifierTypes.START_DOWNLOAD_FILTER,EventNotifierTypes.SUCCESS_DOWNLOAD_FILTER,EventNotifierTypes.ERROR_DOWNLOAD_FILTER,EventNotifierTypes.UPDATE_USER_FILTER_RULES,EventNotifierTypes.UPDATE_WHITELIST_FILTER_RULES,EventNotifierTypes.CONTENT_BLOCKER_UPDATED,EventNotifierTypes.REQUEST_FILTER_UPDATED];contentPage.sendMessage({type:"addEventListener",events:e},function(e){t=e.listenerId}),contentPage.onMessage.addListener(function(e){"notifyListeners"==e.type&&function(e,t){switch(e){case EventNotifierTypes.ENABLE_FILTER:case EventNotifierTypes.DISABLE_FILTER:i._onBlockFilterStateChange(t);break;case EventNotifierTypes.ADD_FILTER:i._addFilters(t);break;case EventNotifierTypes.REMOVE_FILTER:i._delFilters(t);break;case EventNotifierTypes.MODIFY_FILTER:i._modifyFilters(t);break;case EventNotifierTypes.START_DOWNLOAD_FILTER:break;case EventNotifierTypes.SUCCESS_DOWNLOAD_FILTER:i._modifyFilters(t),progressUI(t.filterId,!1);break;case EventNotifierTypes.ERROR_DOWNLOAD_FILTER:i._errordownload(t);break;case EventNotifierTypes.UPDATE_USER_FILTER_RULES:if(0<i.omitRenderEventsCount){i.omitRenderEventsCount--;break}i._renderUserFilters(),environmentOptions.isContentBlockerEnabled;break;case EventNotifierTypes.UPDATE_WHITELIST_FILTER_RULES:if(0<i.omitRenderEventsCount){i.omitRenderEventsCount--;break}i._renderWhiteDomains();break;case EventNotifierTypes.REQUEST_FILTER_UPDATED:if(environmentOptions.isContentBlockerEnabled)break;console.log("加载完成");break;case EventNotifierTypes.CONTENT_BLOCKER_UPDATED:i.renderFilterRulesInfo(t)}}.apply(this,e.args)});var n=function(){t&&(contentPage.sendMessage({type:"removeListener",listenerId:t}),t=null)};$(window).on("beforeunload",n),$(window).on("unload",n)})});