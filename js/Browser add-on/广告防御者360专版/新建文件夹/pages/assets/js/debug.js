var PageController=function(){this.requestWizard=new RequestWizard},Messages={OPTIONS_USERFILTER:i18n.getMessage("options_userfilter"),OPTIONS_WHITELIST:i18n.getMessage("options_whitelist"),IN_WHITELIST:i18n.getMessage("filtering_log_in_whitelist")},StringUtils={startWith:function(e,t){return e&&0===e.indexOf(t)},containsIgnoreCase:function(e,t){return e&&t&&0<=e.toUpperCase().indexOf(t.toUpperCase())},substringAfter:function(e,t){if(!e)return e;var n=e.indexOf(t);return n<0?"":e.substring(n+t.length)},substringBefore:function(e,t){if(!e||!t)return e;var n=e.indexOf(t);return n<0?e:e.substring(0,n)}},UrlUtils={getProtocol:function(e){var t=e.indexOf("//");return 0<=t?e.substring(0,t):0<=(t=e.indexOf(":"))?e.substring(0,t):""},getDomainName:function(e){return e?(e=this.getUrlWithoutScheme(e),this.linkHelper||(this.linkHelper=document.createElement("a")),this.linkHelper.href="http://"+e,this.linkHelper.hostname):null},getUrlWithoutScheme:function(e){var t=e.indexOf("//");return 0<=t?e=e.substring(t+2):0<=(t=e.indexOf(":"))&&(e=e.substring(t+1)),StringUtils.startWith(e,"www.")?e.substring(4):e},isHierarchicUrl:function(e){return-1!==e.indexOf("//")}},FilterRule={MASK_WHITE_LIST:"@@"},UrlFilterRule={MASK_START_URL:"||",MASK_ANY_SYMBOL:"*",MASK_SEPARATOR:"^",DOMAIN_OPTION:"domain",IMPORTANT_OPTION:"important",MATCH_CASE_OPTION:"match-case",THIRD_PARTY_OPTION:"third-party",OPTIONS_DELIMITER:"$",CSP_OPTION:"csp"};PageController.prototype={init:function(){this.logTable=$("#logTable"),this.logTableEmpty=$("#logTableEmpty"),this.logTableHidden=!0,this.tabSelector=$("#tabSelector"),this.tabSelectorValue=this.tabSelector.find(".task-manager-header-dropdown-select-text"),this.tabSelectorList=this.tabSelector.find(".task-manager-header-dropdown-select-list"),this.logoIcon=$("#logoIcon"),this.tabSelectorValue.dropdown(),this.tabSelector.on("show.bs.dropdown",function(){this.tabSelector.addClass("opened")}.bind(this)),this.tabSelector.on("hide.bs.dropdown",function(){this.tabSelector.removeClass("opened")}.bind(this)),this.tabSelectorList.on("click","div",function(e){var t=$(e.currentTarget);document.location.hash="#"+t.attr("data-tab-id")}.bind(this)),$(window).on("hashchange",function(){this._updateTabIdFromHash(),this.onSelectedTabChange()}.bind(this)),this.searchRequest=null,this.searchTypes=[],this.searchThirdParty=!1,this.searchBlocked=!1,this.searchWhitelisted=!1,$(".task-manager").on("click",".reloadTab",function(e){e.preventDefault(),contentPage.sendMessage({type:"reloadTabById",tabId:this.currentTabId})}.bind(this)),$("#clearTabLog").on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"clearEventsByTabId",tabId:this.currentTabId})}.bind(this));var a=this;this.logTable.on("click",".task-manager-content-header-body-row",function(){var n=$(this).data();contentPage.sendMessage({type:"getTabFrameInfoById",tabId:a.currentTabId},function(e){var t=e.frameInfo;t&&a.requestWizard.showRequestInfoModal(t,n)})}),this._bindSearchFilters(),this._updateTabIdFromHash(),contentPage.sendMessage({type:"synchronizeOpenTabs"},function(e){for(var t=e.tabs,n=0;n<t.length;n++)this.onTabUpdated(t[n]);this.onSelectedTabChange()}.bind(this))},_updateTabIdFromHash:function(){if(document.location.hash){var e=document.location.hash.substring(1);e&&(this.currentTabId=e)}},onTabAdded:function(e){e.isHttp&&(this.tabSelectorList.append($("<div>",{class:"task-manager-header-dropdown-select-list-item",text:e.tab.title,"data-tab-id":e.tabId})),this.currentTabId||this.onSelectedTabChange())},onTabUpdated:function(e){var t=this.tabSelectorList.find("[data-tab-id="+e.tabId+"]");e.isHttp?t&&0<t.length?(t.text(e.tab.title),e.tabId==this.currentTabId&&(this.tabSelectorValue.text(e.tab.title),this._updateLogoIcon())):this.onTabAdded(e):this.onTabClose(e)},onTabClose:function(e){this.tabSelectorList.find("[data-tab-id="+e.tabId+"]").remove(),this.currentTabId==e.tabId&&(this.currentTabId=null,this.onSelectedTabChange())},onTabReset:function(e){this.currentTabId==e.tabId&&(this.logTable.empty(),this._onEmptyTable())},onEventAdded:function(e,t){this.currentTabId==e.tabId&&this._renderEvents([t])},onEventUpdate:function(e,t){this.currentTabId==e.tabId&&this._UpdateTime([t])},_UpdateTime:function(e){if(e&&0!=e.length)for(var t=this.logTable.find(".task-manager-content-header-body-row"),n=!1,a=0;a<t.length;a++){for(var r=$(t[a]).find(".task-manager-content-item-url").text(),i=0;i<e.length;i++)if(r==e[i].requestUrl){$(t[a]).find(".task-manager-content-item-time").text(e[i].loadTime+"ms"),n=!0;break}if(n)break}else this._onEmptyTable()},onSelectedTabChange:function(){var e=this.tabSelectorList.find('[data-tab-id="'+this.currentTabId+'"]');0==e.length&&(e=this.tabSelectorList.find(":first"));var t="",n=null;0<e.length&&(t=e.text(),n=e.attr("data-tab-id")),this.currentTabId=n,this.tabSelectorValue.text(t),this._updateLogoIcon(),this._renderEventsForTab(this.currentTabId)},_updateLogoIcon:function(){contentPage.sendMessage({type:"getTabFrameInfoById",tabId:this.currentTabId},function(e){var t="../icons/new-26.png";e.frameInfo&&(t="../icons/new-26.png"),this.logoIcon.attr("src",t)}.bind(this))},_bindSearchFilters:function(){var a=this;$('[name="searchEventRequest"]').on("keyup",function(){a.searchRequest=this.value.trim(),a._filterEvents()});var r=$(".searchEventType");r.on("click",function(e){e.preventDefault(),r.parent().removeClass("active");var t=$(e.currentTarget);t.parent().addClass("active");var n=t.attr("attr-type");a.searchTypes=n?n.split(","):[],a._filterEvents()}),$('[name="searchEventThirdParty"]').on("change",function(){a.searchThirdParty=this.checked,a._filterEvents()}),$('[name="searchEventBlocked"]').on("change",function(){a.searchBlocked=this.checked,a._filterEvents()}),$('[name="searchEventWhitelisted"]').on("change",function(){a.searchWhitelisted=this.checked,a._filterEvents()})},_filterEvents:function(){var e=this.logTable.children();if(this.searchRequest||0!=this.searchTypes.length||this.searchThirdParty||this.searchBlocked||this.searchWhitelisted){var t=this;$.each(e,function(){t._handleEventShow($(this))})}else e.removeClass("hidden")},_onEmptyTable:function(){this.logTableHidden=!0,this.logTable.addClass("hidden"),this.logTableEmpty.removeClass("hidden")},_onNotEmptyTable:function(){this.logTableHidden&&(this.logTableHidden=!1,this.logTableEmpty.addClass("hidden"),this.logTable.removeClass("hidden"))},_renderEventsForTab:function(e){this.logTable.empty(),contentPage.sendMessage({type:"getTabInfoById",tabId:e},function(e){var t=e.tabInfo,n=[];t&&(n=t.filteringEvents||[]),this._renderEvents(n)}.bind(this))},_renderEvents:function(e){if(e&&0!=e.length){for(var t=[],n=0;n<e.length;n++){var a=this._renderTemplate(e[n]);this._handleEventShow(a),t.push(a)}this._onNotEmptyTable(),this.logTable.append(t)}else this._onEmptyTable()},_renderTemplate:function(e){var t={data:e,class:"task-manager-content-header-body-row cf"};e.requestRule&&(t.class+=e.requestRule.whiteListRule?" green":" red");var n="";e.requestRule&&(n=e.requestRule.filterId===AntiBannerFiltersId.WHITE_LIST_FILTER_ID?Messages.IN_WHITELIST:e.requestRule.ruleText);var a="task-manager-content-header-body-col task-manager-content-item-type";e.requestThirdParty&&(a+=" third-party");var r=$("<div>",t);r.append($("<div>",{text:e.requestUrl,class:"task-manager-content-header-body-col task-manager-content-item-url"})),r.append($("<div>",{text:RequestWizard.getRequestType(e.requestType),class:a})),r.append($("<div>",{text:n,class:"task-manager-content-header-body-col task-manager-content-item-rule"})),r.append($("<div>",{text:RequestWizard.getSource(e.frameDomain),class:"task-manager-content-header-body-col task-manager-content-item-source"}));var i=e.loadTime||"0";return r.append($("<div>",{text:i+"ms",class:"task-manager-content-header-body-col task-manager-content-item-time"})),r},_handleEventShow:function(e){var t=e.data(),n=!this.searchRequest||StringUtils.containsIgnoreCase(t.requestUrl,this.searchRequest);n&=0==this.searchTypes.length||0<=this.searchTypes.indexOf(t.requestType);var a=!(this.searchWhitelisted||this.searchBlocked||this.searchThirdParty);a|=this.searchWhitelisted&&t.requestRule&&t.requestRule.whiteListRule,a|=this.searchBlocked&&t.requestRule&&!t.requestRule.whiteListRule,(n&=a|=this.searchThirdParty&&t.requestThirdParty)?e.removeClass("hidden"):e.addClass("hidden")}};var userSettings,enabledFilters,environmentOptions,AntiBannerFiltersId,EventNotifierTypes,LogEvents,filtersMetadata,RequestWizard=function(){this.requestInfoTemplate=$("#modal-request-info"),this.createBlockRuleTemplate=$("#modal-create-block-rule"),this.createExceptionRuleTemplate=$("#modal-create-exception-rule")};RequestWizard.getFilterName=function(t){if(t==AntiBannerFiltersId.USER_FILTER_ID)return Messages.OPTIONS_USERFILTER;if(t==AntiBannerFiltersId.WHITE_LIST_FILTER_ID)return Messages.OPTIONS_WHITELIST;var e=filtersMetadata.filter(function(e){return e.filterId==t})[0];return e.title=e.title||e.name,e?e.title:""},RequestWizard.prototype.showModal=function(e){$(document.body).append(e),e.show(),e.modal(),e.on("hidden.bs.modal",function(){$(this).remove()}),this.currentModal=e},RequestWizard.prototype.closeModal=function(){this.currentModal&&(this.currentModal.modal("hide"),this.currentModal=null)},RequestWizard.prototype.showRequestInfoModal=function(t,n){var e=this.requestInfoTemplate.clone(),a=n.requestRule;if(e.find('[attr-text="requestUrl"]').text(n.requestUrl),e.find('[attr-text="requestType"]').text(RequestWizard.getRequestType(n.requestType)),e.find('[attr-text="frameDomain"]').text(RequestWizard.getSource(n.frameDomain)),n.frameDomain&&null!=n.frameDomain||e.find('[attr-text="frameDomain"]').closest(".adg-modal-window-locking-info-left-row").hide(),a?(a.filterId!=AntiBannerFiltersId.WHITE_LIST_FILTER_ID?e.find('[attr-text="requestRule"]').text(a.ruleText):e.find('[attr-text="requestRule"]').closest(".adg-modal-window-locking-info-left-row").hide(),e.find('[attr-text="requestRuleFilter"]').text(RequestWizard.getFilterName(a.filterId))):(e.find('[attr-text="requestRule"]').closest(".adg-modal-window-locking-info-left-row").hide(),e.find('[attr-text="requestRuleFilter"]').closest(".adg-modal-window-locking-info-left-row").hide()),"IMAGE"==n.requestType){e.removeClass("compact-view");var r=e.find('[attr-src="requestUrl"]'),i=new Image;i.src=n.requestUrl,i.onload=function(){var e=this.width,t=this.height;1<e&&1<t&&(r.attr("src",n.requestUrl),r.parent().show())}}e.find("#openRequestNewTab").on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"openTab",url:n.requestUrl,options:{inNewWindow:!0}})});var s=e.find("#blockRequest"),o=e.find("#unblockRequest"),l=e.find("#removeWhiteListDomain"),d=e.find("#removeUserFilterRule");s.on("click",function(e){e.preventDefault(),this.closeModal(),this.showCreateBlockRuleModal(t,n)}.bind(this)),o.on("click",function(e){e.preventDefault(),this.closeModal(),this.showCreateExceptionRuleModal(t,n)}.bind(this)),l.on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"unWhiteListFrame",frameInfo:t}),this.closeModal()}.bind(this)),d.on("click",function(e){e.preventDefault(),contentPage.sendMessage({type:"removeUserFilter",text:a.ruleText}),this.closeModal()}.bind(this)),a?a.filterId==AntiBannerFiltersId.USER_FILTER_ID?d.removeClass("hidden"):a.filterId==AntiBannerFiltersId.WHITE_LIST_FILTER_ID?l.removeClass("hidden"):a.whiteListRule||o.removeClass("hidden"):s.removeClass("hidden"),this.showModal(e)},RequestWizard.prototype.showCreateBlockRuleModal=function(e,t){var n=this.createBlockRuleTemplate.clone(),a=RequestWizard.splitToPatterns(t,!1).reverse();this._initCreateRuleDialog(e,n,a,t)},RequestWizard.prototype.showCreateExceptionRuleModal=function(e,t){var n=this.createExceptionRuleTemplate.clone(),a=(FilterRule.MASK_WHITE_LIST,UrlFilterRule.MASK_START_URL,RequestWizard.splitToPatterns(t,!0).reverse());this._initCreateRuleDialog(e,n,a,t)},RequestWizard.prototype._initCreateRuleDialog=function(n,e,t,d){for(var c=d.frameDomain,a=d.requestThirdParty,r=e.find("#rulePatterns"),i=0;i<t.length;i++){var s=$("<div>",{class:"radio radio-patterns"}),o=$("<input>",{class:"radio-input",type:"radio",name:"rulePattern",id:"pattern"+i,value:t[i]}),l=$("<label>",{class:"radio-label",for:"pattern"+i}).append($("<span>",{class:"radio-icon"})).append($("<span>",{class:"radio-label-text",text:t[i]}));s.append(o),s.append(l),r.append(s),0===i&&o.attr("checked","checked")}var u=e.find('[name="rulePattern"]'),h=e.find('[name="ruleDomain"]'),T=e.find('[name="ruleImportant"]'),f=e.find('[name="ruleMatchCase"]'),g=e.find('[name="ruleThirdParty"]'),p=e.find('[name="ruleText"]');function b(){var e=u.filter(":checked").val(),t=!h.is(":checked"),n=T.is(":checked"),a=f.is(":checked"),r=g.is(":checked"),i=t?c:null,s=null,o=d.requestRule;o&&o.cspRule&&(s=[UrlFilterRule.CSP_OPTION]);var l=RequestWizard.createRuleFromParams(e,i,a,r,n,s);p.val(l)}h.attr("id","ruleDomain"),h.parent().find("label").attr("for","ruleDomain"),c||h.closest(".checkbox").hide(),T.attr("id","ruleImportant"),T.parent().find("label").attr("for","ruleImportant"),f.attr("id","ruleMatchCase"),f.parent().find("label").attr("for","ruleMatchCase"),g.attr("id","ruleThirdParty"),g.parent().find("label").attr("for","ruleThirdParty"),a&&g.attr("checked","checked"),h.on("change",b),T.on("change",b),f.on("change",b),g.on("change",b),u.on("change",b),e.find("#createRule").on("click",function(e){e.preventDefault();var t=p.val();t&&(contentPage.sendMessage({type:"addUserRule",ruleText:t,adguardDetected:n.adguardDetected}),this.closeModal())}.bind(this)),b(),this.showModal(e)},RequestWizard.PATTERNS_COUNT=2,RequestWizard.splitToPatterns=function(e,t){var n,a=e.requestUrl,r=e.requestDomain,i=UrlUtils.isHierarchicUrl(a),s=UrlUtils.getProtocol(a);n=i?UrlFilterRule.MASK_START_URL:s+":",t&&(n=FilterRule.MASK_WHITE_LIST+n);var o=[],l=StringUtils.substringAfter(a,r+"/"),d=StringUtils.substringBefore(l,"?");if(d){for(var c=d.split("/"),u=r+"/",h=0;h<Math.min(c.length-1,RequestWizard.PATTERNS_COUNT);h++)u+=c[h]+"/",o.push(n+u+UrlFilterRule.MASK_ANY_SYMBOL);var T=c[c.length-1];T&&o.length<RequestWizard.PATTERNS_COUNT&&(u+=T,o.push(n+u))}o.unshift(n+r+UrlFilterRule.MASK_SEPARATOR);var f=UrlUtils.getUrlWithoutScheme(a);return r+"/"!==f&&o.indexOf(n+f)<0&&o.push(n+f),o},RequestWizard.createRuleFromParams=function(e,t,n,a,r,i){var s=e,o=[];return t&&o.push(UrlFilterRule.DOMAIN_OPTION+"="+t),r&&o.push(UrlFilterRule.IMPORTANT_OPTION),n&&o.push(UrlFilterRule.MATCH_CASE_OPTION),a&&o.push(UrlFilterRule.THIRD_PARTY_OPTION),i&&(o=o.concat(i)),0<o.length&&(s+=UrlFilterRule.OPTIONS_DELIMITER+o.join(",")),s},RequestWizard.getRequestType=function(e){switch(e){case"DOCUMENT":case"SUBDOCUMENT":return"HTML";case"STYLESHEET":return"CSS";case"SCRIPT":return"JavaScript";case"XMLHTTPREQUEST":return"Ajax";case"IMAGE":return"Image";case"OBJECT":case"OBJECT-SUBREQUEST":case"MEDIA":return"Media";case"FONT":return"Font";case"WEBSOCKET":return"WebSocket";case"WEBRTC":return"WebRTC";case"CSP":return"CSP";case"OTHER":return"Other"}return""},RequestWizard.getSource=function(e){return e||""},contentPage.sendMessage({type:"initializeFrameScript"},function(e){userSettings=e.userSettings,enabledFilters=e.enabledFilters,filtersMetadata=e.filtersMetadata,environmentOptions=e.environmentOptions,AntiBannerFiltersId=e.constants.AntiBannerFiltersId,EventNotifierTypes=e.constants.EventNotifierTypes,LogEvents=e.constants.LogEvents,$(document).ready(function(){var a=new PageController;var t,e=[LogEvents.TAB_ADDED,LogEvents.TAB_UPDATE,LogEvents.TAB_CLOSE,LogEvents.TAB_RESET,LogEvents.EVENT_ADDED,LogEvents.EVENT_UPDATE];contentPage.sendMessage({type:"onOpenFilteringLogPage"}),contentPage.sendMessage({type:"addEventListener",events:e},function(e){t=e.listenerId}),contentPage.onMessage.addListener(function(e){"notifyListeners"==e.type&&function(e,t,n){switch(e){case LogEvents.TAB_ADDED:a.onTabAdded(t);break;case LogEvents.TAB_UPDATE:a.onTabUpdated(t);break;case LogEvents.TAB_CLOSE:a.onTabClose(t);break;case LogEvents.TAB_RESET:a.onTabReset(t);break;case LogEvents.EVENT_ADDED:a.onEventAdded(t,n);break;case LogEvents.EVENT_UPDATE:a.onEventUpdate(t,n)}}.apply(this,e.args)});var n=function(){t&&(contentPage.sendMessage({type:"removeListener",listenerId:t}),contentPage.sendMessage({type:"onCloseFilteringLogPage"}),t=null)};$(window).on("beforeunload",n),$(window).on("unload",n),a.init()})});