!function(){"use strict";var f="Content-Security-Policy",y="connect-src http: https:; frame-src http: https:; child-src http: https:",u=vAPI.EventNotifierTypes,c=vAPI.EventNotifier,r=vAPI.ext.webRequest,n=[],o=1,a=Object.create(null);function i(e,r,t,s){if(r){delete a[e];var i=yiclear.webRequestService.getRuleForRequest(s,r,t,vAPI.RequestTypes.POPUP);yiclear.webRequestService.isRequestBlockedByRule(i)&&(vAPI.ext.tabs.remove(e),yiclear.webRequestService.postProcessRequest(s,r,t,vAPI.RequestTypes.DOCUMENT,i))}}if(vAPI.ext.webNavigation.onCreatedNavigationTarget.addListener(function(e){var r={id:e.sourceTabId};if(!yiclear.framesMap.isTabyiclearDetected(r)){var t=yiclear.framesMap.getMainFrameUrl(r)||e.url;if(vAPI.UrlUtils.isHttpRequest(t)){var s=e.tabId;a[s]={referrerUrl:t,sourceTab:r},i(s,e.url,t,r)}}},{urls:["<all_urls>"]}),vAPI.ext.tabs.onUpdated.addListener(function(e){var r=e.id;if(r in a&&e.url){var t=a[r];t&&i(r,e.url,t.referrerUrl,t.sourceTab)}}),r.onCompleted.addListener(function(e){var r=function(e){for(var r={loadtime:null,RequestTypes:null,tab:null},t=0;t<n.length;t++){var s=n[t];s.requestUrl===e.url&&(r.loadtime=e.timeStamp-s.requestTime,r.tab=s.tab,r.RequestTypes=s.requestType,n.splice(t-n.length,1))}return r.loadtime=Math.round(r.loadtime),r}(e),t=e.url;yiclear.webRequestService.filteringLogEventUpdate(r.tab,t,r.RequestTypes,r.loadtime)},{urls:["<all_urls>"]},["responseHeaders"]),r.onBeforeRequest.addListener(function(e){var r=e.tab,t=e.requestUrl,s=e.requestType;if(s!==vAPI.RequestTypes.DOCUMENT&&s!==vAPI.RequestTypes.SUBDOCUMENT||(n.push(e),yiclear.framesMap.recordFrame(r,e.frameId,t,s)),s===vAPI.RequestTypes.DOCUMENT&&c.notifyListeners(u.UPDATE_TAB_BUTTON_STATE,r,!0),!vAPI.UrlUtils.isHttpRequest(t))return!0;var i=yiclear.framesMap.getFrameUrl(r,e.requestFrameId),a=yiclear.webRequestService.getRuleForRequest(r,t,i,s);if(null!==a&&void 0!==a.RedirectUrls)return{redirectUrl:t.replace(a.urlRegExp,a.RedirectUrls)};if(s===vAPI.RequestTypes.DOCUMENT)return!0;if(null!==a&&void 0!==a.BCount)return!(1<++o&&o%Number(a.BCount)==0);yiclear.webRequestService.postProcessRequest(r,t,i,s,a);var l=yiclear.webRequestService.getBlockedResponseByRule(a);return l||n.push(e),l},["<all_urls>"]),r.onBeforeSendHeaders.addListener(function(e){var r=e.tab,t=e.requestHeaders;if("DOCUMENT"===e.requestType){var s=vAPI.platformUtils.findHeaderByName(t,"Referer");s&&yiclear.framesMap.recordFrameReferrerHeader(r,s.value)}},["<all_urls>"],["blocking","requestHeaders"]),r.onHeadersReceived.addListener(function(e){var r=e.tab,t=e.requestUrl,s=e.responseHeaders,i=e.requestType,a=yiclear.framesMap.getFrameUrl(r,e.requestFrameId);if(yiclear.webRequestService.processRequestResponse(r,t,a,i,s),i===vAPI.RequestTypes.DOCUMENT||i===vAPI.RequestTypes.SUBDOCUMENT)return function(e){if(!vAPI.platformUtils.isEdgeBeforeCreatorsUpdate()){var r,t,s,i,a=e.tab,l=e.requestUrl,u=e.responseHeaders||[],c=e.requestType,n=yiclear.framesMap.getFrameUrl(a,e.frameId),o=[],d=(r=a,t=n,s=null,i=!1,vAPI.ext.webRequest.webSocketSupported||(s=yiclear.webRequestService.getRuleForRequest(r,"ws://yiclearwebsocket.check",t,vAPI.RequestTypes.WEBSOCKET),i=yiclear.webRequestService.isRequestBlockedByRule(s)),i||(s=yiclear.webRequestService.getRuleForRequest(r,"blob:yiclearblob.check",t,vAPI.RequestTypes.SCRIPT),i=yiclear.webRequestService.isRequestBlockedByRule(s)),i||(s=yiclear.webRequestService.getRuleForRequest(r,"stun:yiclearwebrtc.check",t,vAPI.RequestTypes.WEBRTC)),s);yiclear.webRequestService.isRequestBlockedByRule(d)&&o.push({name:f,value:y}),d&&yiclear.filteringLog.addEvent(a,"content-security-policy-check",n,vAPI.RequestTypes.CSP,d);var v=yiclear.webRequestService.getCspRules(a,l,n,c);if(v)for(var R=0;R<v.length;R++){var p=v[R];yiclear.webRequestService.isRequestBlockedByRule(p)&&o.push({name:f,value:p.cspDirective}),yiclear.filteringLog.addEvent(a,l,n,vAPI.RequestTypes.CSP,p)}return 0<o.length?{responseHeaders:u=u.concat(o),modifiedHeaders:o}:void 0}}(e)},["<all_urls>"]),!vAPI.platformUtils.isEdgeBrowser()){var e=vAPI.ext.getURL("elemhidehit.png");r.onBeforeRequest.addListener(function(e){if(!yiclear.framesMap.isIncognitoTab(e.tab)){var r=yiclear.framesMap.getFrameDomain(e.tab),t=function(e){if(!e)return null;var r=decodeURIComponent(vAPI.StringUtils.substringAfter(e,"#"));return{filterId:vAPI.StringUtils.substringBefore(r,";"),ruleText:vAPI.StringUtils.substringAfter(r,";")}}(e.requestUrl);t&&yiclearAPI.filterRulesHitCount.addRuleHit(r,t.ruleText,t.filterId)}},[e])}var l,t=null;c.addListener(function(e){switch(e){case u.ADD_RULE:case u.ADD_RULES:case u.REMOVE_RULE:case u.UPDATE_FILTER_RULES:case u.ENABLE_FILTER:case u.DISABLE_FILTER:null!=t&&clearTimeout(t),t=setTimeout(function(){t=null,r.handlerBehaviorChanged()},3e3)}}),l=vAPI.platformUtils.isEdgeBrowser(),vAPI.ext.webNavigation.onCommitted.addListener(function(e,r,t){if(0===r||!l){var s=yiclear.webRequestService.processGetSelectorsAndScripts({tabId:e},t,{filter:["scripts"]});s.scripts&&0!==s.scripts.length&&(s.type="injectScripts",function r(t,s,i,a,l){vAPI.ext.tabs.sendMessage(t,a,function(e){if(!e){if(--l<=0)return;setTimeout(function(){r(t,s,i,a,l)},10)}})}(e,r,t,s,5))}})}();