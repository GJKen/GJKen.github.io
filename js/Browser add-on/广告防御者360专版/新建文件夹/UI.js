!function(d,b){d.UI={ICON_OPEN:b.ext.getURL("icons/new-19.png"),ICON_CLOSE:b.ext.getURL("icons/new-19-close.png"),nextMenuId:0,browserActionTitle:b.ext.i18n.getMessage("name"),updateTabIconAndContextMenu:function(t,e){e&&yiclear.framesMap.reloadFrameData(t),this.updateTabIcon(t),this.updateTabContextMenu(t)},getAllOpenedTabs:function(n){var t=b.ext,a=[],i=[],o=function(t){var e=new b.vPromise;return t.getAllTabs(function(t){i=i.concat(t),e.resolve()}),e},e=new b.vPromise;t.windows.getAll(function(t){a=i.concat(t),e.resolve()}),e.then(function(){for(var t=[],e=0;e<a.length;e++)t.push(o(a[e]));b.vPromise.all(t).then(function(){n(i)})})},openTab:function(i,t){var o,s,c,r,u=b.ext,e=b.StringUtils,l=b.UrlUtils;t&&(o=t.inBackground,s=t.activateSameTab,c=t.onOpen,r=t.tabType);"Edge"!=d.Prefs.platform&&(i=e.contains(i,"://")?i:u.getURL(i));var p=!l.isHttpRequest(i);this.getAllOpenedTabs(function(t){if(s)for(var e=0;e<t.length;e++){var n=t[e];if(l.urlEquals(n.url,i))return(a=n).url!=i&&a.reload(i),o||a.activate(),void(c&&c(a))}var a;"popup"==r?u.windows.createPopup(i,c):u.windows.getOrCreate(function(t){t.openTab(i,o,c)},p)})},openOptions:function(){var t=b.ext,i=t.getURL("pages/install.html"),o=t.getURL("pages/options.html");t.windows.getLastFocused(function(a){a.getAllTabs(function(t){for(var e=0;e<t.length;e++){var n=t[e];if(n.url==i||n.url==o)return n.active||n.activate(),void(n.url!=o&&("Edge"==d.Prefs.platform?n.reload("pages/options.html"):n.reload(o)))}"Edge"==d.Prefs.platform?a.openTab("pages/options.html"):a.openTab(o)})})},openInstallPage:function(){this.openTab("pages/install.html",{inBackground:!1})},openExportRulesTab:function(t){this.openTab("pages/export.html#"+t)},updateTabIcon:function(t,e){var n,a;if(e)n=e.icon,d.userSettings.showtabIconBlock()&&(a=e.badge);else{var i,o,s=yiclear.framesMap.getFrameInfo(t);s.yiclearDetected?(o=s.documentWhiteListed,i=""):i=!(o=(o=(o=s.applicationFilteringDisabled)||s.urlFilteringDisabled)||s.documentWhiteListed)&&d.userSettings.showPageStatistic()?s.totalBlockedTab.toString():"0",d.userSettings.showtabIconBlock()&&(a=this._getBlockedCountText(i)),n=o?this.ICON_CLOSE:(s.yiclearDetected,this.ICON_OPEN)}d.userSettings.showtabIconBlock()?b.ext.browserAction.setBrowserAction(t,n,a,"#555",this.browserActionTitle):b.ext.browserAction.setBrowserAction(t,n,"","#555",this.browserActionTitle)},updateTabIconAsync:b.platformUtils.debounce(function(t){d.UI.updateTabIcon(t)},250),_getBlockedCountText:function(t){var e="0"==t?"":t;return 999<t-0&&(e="âˆž"),e},updateTabContextMenu:function(t){b.ext.contextMenus.removeAll(),d.userSettings.showContextMenu()&&d.UI.customizeContextMenu(t)},customizeContextMenu:function(n){var o={context_open_log:function(){var t=yiclear.filteringLog.getTabInfo(n),e=t?t.tabId:null;d.UI.openFilteringLog(e)},context_open_block:function(){d.UI.openAssistant(!0)}};!function(t,e){var n,a={contexts:["all"],title:b.ext.i18n.getMessage(t)};e&&(e.id&&(a.id=e.id),e.parentId&&(a.parentId=e.parentId),e.disabled&&(a.enabled=!1),e.messageArgs&&(a.title=ext.i18n.getMessage(t,e.messageArgs)),e.contexts&&(a.contexts=e.contexts),n=e.callbackTitle);var i=o[n||t];i&&(a.onclick=i),b.ext.contextMenus.create(a)}("context_open_block")},openAssistant:function(e){this._getCurrentTab(function(t){t.sendMessage({type:"initAssistant",options:{selectElement:e}})})},bindEvents:function(){var t=b.EventNotifier;t.addListener(function(t,e,n){var a;t==b.EventNotifierTypes.UPDATE_TAB_BUTTON_STATE&&e&&(n&&(a={icon:d.UI.ICON_CLOSE,badge:""}),d.UI.updateTabIcon(e,a))}),t.addListener(function(t,e,n,a){t==b.EventNotifierTypes.ADS_BLOCKED&&n&&(null!=yiclear.framesMap.updateBlockedAdsCount(n,a)&&this.updateTabIconAsync(n))}.bind(this)),t.addListener(function(t,e){t==b.EventNotifierTypes.CHANGE_USER_SETTINGS&&e==d.userSettings.settings.DISABLE_SHOW_CONTEXT_MENU&&b.ext.windows.getLastFocused(function(t){t.getActiveTab(function(t){d.UI.updateTabContextMenu(t)})})}),b.ext.tabs.onLoading.addListener(function(t){d.UI.updateTabIconAndContextMenu(t)}),b.ext.tabs.onCompleted.addListener(function(t){d.UI.updateTabIconAndContextMenu(t)}),b.ext.tabs.onActivated.addListener(function(t){d.UI.updateTabIconAndContextMenu(t,!0)}),b.ext.windows.onFocusChanged.addListener(function(){b.ext.windows.getLastFocused(function(t){t.getActiveTab(function(t){d.UI.updateTabIconAndContextMenu(t,!0)})})})},getAssistantCssOptions:function(){return{cssLink:[b.ext.getURL("assistant/css/assistant.css")]}},whiteListTab:function(t){var e=yiclear.framesMap.getFrameInfo(t);yiclear.antiBannerService.whiteListFrame(e),this.updateTabIconAndContextMenu(t,!0)},whiteListCurrentTab:function(){this._getCurrentTab(function(t){this.whiteListTab(t)}.bind(this))},unWhiteListTab:function(t){var e=yiclear.framesMap.getFrameInfo(t);yiclear.antiBannerService.unWhiteListFrame(e),this.updateTabIconAndContextMenu(t,!0)},unWhiteListCurrentTab:function(){this._getCurrentTab(function(t){this.unWhiteListTab(t)}.bind(this))},_getCurrentTab:function(e){b.ext.tabs.getLastFocused(function(t){t&&e&&e(t)})},openFilteringLog:function(t){"undefined"!=typeof sogouExplorer?this.openTab("pages/debug.html"+(t?"#"+t:""),{activateSameTab:!0,tabType:"panel"}):this.openTab("pages/debug.html"+(t?"#"+t:""),{activateSameTab:!0,tabType:"popup"})},openIssue:function(){this.openTab("https://www.yiclear.com/Issue.html",{activateSameTab:!0,tabType:"popup"})},openFeedback:function(){this.openTab("https://www.yiclear.com/ask/",{activateSameTab:!0,tabType:"popup"})}}}(yiclearAPI,vAPI);